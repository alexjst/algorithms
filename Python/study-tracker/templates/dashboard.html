<!DOCTYPE html>
<html>
<head>
    <title>Study Tracker - Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header { background: #f0f8ff; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .topic { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .review { background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .complete-btn { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .complete-btn:hover { background: #218838; }
        .rating { margin: 5px 0; }
        .notes { width: 100%; height: 60px; margin: 5px 0; }
        /* New Navigation Bar Styles */
        .nav-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allows wrapping on very small screens */
            background-color: #ffffff;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        .nav-link {
            display: flex; /* Aligns icon and text */
            align-items: center;
            white-space: nowrap; /* Prevents icon and text from breaking lines */
            text-decoration: none;
            color: #495057;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: #f1f3f5;
            color: #007bff;
        }
        .nav-link.active {
            background-color: #e7f3ff;
            color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }
        .time-estimate { color: #666; font-size: 0.9em; }
        .detailed-content { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .detailed-content pre { white-space: pre-wrap; margin: 0; font-family: inherit; }
        .problems-section, .resources-section, .concepts-section, .practice-section { margin: 15px 0; }
        .practice-section { background: #fff9e6; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; }
        .question-category { margin: 15px 0; }
        .question-category h5 { color: #856404; margin-bottom: 10px; }
        .question-category ul { padding-left: 20px; }
        .question-category li { margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .problem-item, .resource-item { margin: 10px 0; padding: 10px; border: 1px solid #e9ecef; border-radius: 5px; background: #f8f9fa; }
        .problem-link, .resource-link { color: #007bff; text-decoration: none; font-size: 16px; }
        .problem-link:hover, .resource-link:hover { text-decoration: underline; }
        .difficulty { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }
        .problem-desc, .resource-desc { color: #666; margin: 5px 0 0 0; font-size: 14px; }
        .concepts-section ul { margin: 10px 0; }
        .concepts-section li { margin: 5px 0; }
        .completed-section { opacity: 0.6; pointer-events: none; }
        .completed-section .complete-btn { background: #6c757d; }
        .completed-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        .pomodoro-section { background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffc107; display: none; }
        .pomodoro-timer { font-size: 28px; font-weight: bold; color: #856404; text-align: center; margin: 10px 0; }
        .timer-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin: 5px; cursor: pointer; font-size: 14px; }
        .timer-btn:hover { background: #218838; }
        .timer-btn.pause { background: #ffc107; color: #212529; }
        .timer-btn.pause:hover { background: #e0a800; }
        .timer-btn.stop { background: #dc3545; }
        .timer-btn.stop:hover { background: #c82333; }
        .start-timer-btn { background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-left: 10px; cursor: pointer; font-size: 14px; }
        .start-timer-btn:hover { background: #138496; }
        .template-link { background: #6c757d; color: white; text-decoration: none; padding: 4px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px; }
        .template-link:hover { background: #5a6268; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Study Tracker - Day {{ current_day }}</h1>
        <p><strong>Date:</strong> {{ today }}</p>
        <p><strong>Time Remaining Today:</strong> {{ total_time }} minutes</p>
    </div>

    <!-- New Navigation Bar Structure -->
    <div class="nav-container">
        <a href="/" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" title="Go to Dashboard">üìÖ Dashboard</a>
        <a href="/history" class="nav-link {% if active_page == 'history' %}active{% endif %}" title="View Progress History">üìä History</a>
        <a href="/preview" class="nav-link {% if active_page == 'preview' %}active{% endif %}" title="See Upcoming Topics">üîÆ Preview</a>
        <a href="/practice" class="nav-link {% if active_page == 'practice' %}active{% endif %}" title="Practice & Mock Interviews">üéØ Practice</a>
        <a href="/analytics" class="nav-link {% if active_page == 'analytics' %}active{% endif %}" title="Analyze Your Performance">üìà Analytics</a>
        <a href="/curriculum" class="nav-link {% if active_page == 'curriculum' %}active{% endif %}" title="Edit the Curriculum">üìö Curriculum</a>
        <a href="/templates" class="nav-link {% if active_page == 'templates' %}active{% endif %}" title="Coding Patterns & Templates">üîß Templates</a>
        <a href="/system-design" class="nav-link {% if active_page == 'system-design' %}active{% endif %}" title="System Design Templates">üèóÔ∏è System Design</a>
        <a href="/config" class="nav-link {% if active_page == 'config' %}active{% endif %}" title="Configure Your Plan">‚öôÔ∏è Config</a>
        <a href="/help" class="nav-link {% if active_page == 'help' %}active{% endif %}" title="Get Help">‚ùì Help</a>
    </div>

    <div class="section">
        <h2>üß† Today's Learning</h2>

        {% if coding_topic %}
        <div class="topic {% if coding_topic_completed %}completed-section{% endif %}" id="coding-topic">
            <h3>üíª Coding: {{ coding_topic.topic }}
                <a href="/templates#{{ coding_topic.topic.lower().replace(' ', '-').replace('(', '').replace(')', '') }}" target="_blank" class="template-link" title="View code templates and patterns for {{ coding_topic.topic }}">
                    üìñ Template
                </a>
            </h3>
            <p><strong>Activity:</strong> {{ coding_topic.activity }}</p>

            {% if not coding_topic_completed %}
            <p class="time-estimate">‚è±Ô∏è {{ coding_topic.time_estimate }} minutes
                <button class="start-timer-btn" onclick="console.log('Button clicked!'); try { startPomodoro('coding', {{ coding_topic.time_estimate }}); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" title="Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.">
                    üçÖ Start Timer
                </button>
            </p>

            <div class="pomodoro-section" id="coding-pomodoro">
                <h4>üçÖ Focus Session</h4>
                <div class="pomodoro-timer" id="coding-timer">{{ coding_topic.time_estimate }}:00</div>
                <div style="text-align: center;">
                    <button class="timer-btn" onclick="pauseTimer('coding')" id="coding-pause-btn">‚è∏Ô∏è Pause</button>
                    <button class="timer-btn stop" onclick="stopTimer('coding')">‚èπÔ∏è Stop</button>
                </div>
            </div>
            {% endif %}

            {% if coding_topic.detailed_content %}
            <div class="detailed-content">
                <h4>üìñ Detailed Guide:</h4>
                <pre>{{ coding_topic.detailed_content }}</pre>
            </div>
            {% endif %}

            {% if coding_topic.problems %}
            <div class="problems-section">
                <h4>üéØ Practice Problems:</h4>
                {% for problem in coding_topic.problems %}
                <div class="problem-item">
                    <strong><a href="{{ problem.url }}" target="_blank" class="problem-link">
                        #{{ problem.number }} - {{ problem.title }}
                    </a></strong>
                    <span class="difficulty difficulty-{{ problem.difficulty.lower() }}">{{ problem.difficulty }}</span>
                    <p class="problem-desc">{{ problem.description }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if coding_topic_completed %}
            <div class="completed-message">
                <h4>‚úÖ {{ coding_topic.topic }} Complete!</h4>
                <p>Rating: {{ coding_completion_data.rating }}/5 | Notes: {{ coding_completion_data.notes or 'No notes' }}</p>
                <p><em>Great job! Keep up the momentum! üöÄ</em></p>
            </div>
            {% else %}
            <div class="rating">
                <label>Rating (1-5):</label>
                <select id="coding-rating">
                    <option value="1">1 - Very Hard</option>
                    <option value="2">2 - Hard</option>
                    <option value="3" selected>3 - Medium</option>
                    <option value="4">4 - Easy</option>
                    <option value="5">5 - Very Easy</option>
                </select>
            </div>
            <textarea id="coding-notes" class="notes" placeholder="Notes and reflections..."></textarea>
            <button class="complete-btn" id="coding-complete-btn" onclick="markComplete('{{ coding_topic.topic }}', 'coding', 'topic')">
                ‚úÖ Mark Complete
            </button>
            <button class="complete-btn" id="coding-finish-early-btn" style="display: none; background: #28a745;" onclick="finishEarlyAndMarkComplete('coding', '{{ coding_topic.topic }}')" title="Complete this topic before the timer expires. Shows you finished within the estimated time - great for interview skills!">
                ‚è±Ô∏è Finish Early & Mark Complete
            </button>
            {% endif %}
        </div>
        {% endif %}

        {% if system_design_topic %}
        <div class="topic {% if system_design_topic_completed %}completed-section{% endif %}" id="system_design-topic">
            <h3>üèóÔ∏è System Design: {{ system_design_topic.topic }}</h3>
            <p><strong>Activity:</strong> {{ system_design_topic.activity }}</p>

            {% if not system_design_topic_completed %}
            <p class="time-estimate">‚è±Ô∏è {{ system_design_topic.time_estimate }} minutes
                <button class="start-timer-btn" onclick="console.log('System Design Button clicked!'); try { startPomodoro('system_design', {{ system_design_topic.time_estimate }}); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" title="Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.">
                    üçÖ Start Timer
                </button>
            </p>

            <div class="pomodoro-section" id="system_design-pomodoro">
                <h4>üçÖ Focus Session</h4>
                <div class="pomodoro-timer" id="system_design-timer">{{ system_design_topic.time_estimate }}:00</div>
                <div style="text-align: center;">
                    <button class="timer-btn" onclick="pauseTimer('system_design')" id="system_design-pause-btn">‚è∏Ô∏è Pause</button>
                    <button class="timer-btn stop" onclick="stopTimer('system_design')">‚èπÔ∏è Stop</button>
                </div>
            </div>
            {% endif %}

            {% if system_design_topic.detailed_content %}
            <div class="detailed-content">
                <h4>üìñ Detailed Guide:</h4>
                <pre>{{ system_design_topic.detailed_content }}</pre>
            </div>
            {% endif %}

            {% if system_design_topic.practice_questions %}
            <div class="practice-section">
                <h4>üéØ Practice Questions:</h4>
                <p><em>Test your understanding by answering these questions after studying the materials:</em></p>

                {% if system_design_topic.practice_questions.estimation %}
                <div class="question-category">
                    <h5>üìä Estimation Questions:</h5>
                    <ul>
                        {% for question in system_design_topic.practice_questions.estimation %}
                        <li>{{ question }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if system_design_topic.practice_questions.concepts %}
                <div class="question-category">
                    <h5>üí° Concept Questions:</h5>
                    <ul>
                        {% for question in system_design_topic.practice_questions.concepts %}
                        <li>{{ question }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if system_design_topic.practice_questions.tradeoffs %}
                <div class="question-category">
                    <h5>‚öñÔ∏è Trade-off Questions:</h5>
                    <ul>
                        {% for question in system_design_topic.practice_questions.tradeoffs %}
                        <li>{{ question }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if system_design_topic.resources %}
            <div class="resources-section">
                <h4>üìö Study Resources:</h4>
                {% for resource in system_design_topic.resources %}
                <div class="resource-item">
                    <strong><a href="{{ resource.url }}" target="_blank" class="resource-link">
                        {{ resource.title }}
                    </a></strong>
                    <p class="resource-desc">{{ resource.description }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if system_design_topic.concepts %}
            <div class="concepts-section">
                <h4>üîë Key Concepts:</h4>
                <ul>
                {% for concept in system_design_topic.concepts %}
                    <li>{{ concept }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if system_design_topic_completed %}
            <div class="completed-message">
                <h4>‚úÖ {{ system_design_topic.topic }} Complete!</h4>
                <p>Rating: {{ system_design_completion_data.rating }}/5 | Notes: {{ system_design_completion_data.notes or 'No notes' }}</p>
                <p><em>Great job! Keep up the momentum! üöÄ</em></p>
            </div>
            {% else %}
            <div class="rating">
                <label>Rating (1-5):</label>
                <select id="system_design-rating">
                    <option value="1">1 - Very Hard</option>
                    <option value="2">2 - Hard</option>
                    <option value="3" selected>3 - Medium</option>
                    <option value="4">4 - Easy</option>
                    <option value="5">5 - Very Easy</option>
                </select>
            </div>
            <textarea id="system_design-notes" class="notes" placeholder="Notes and reflections..."></textarea>
            <button class="complete-btn" id="system_design-complete-btn" onclick="markComplete('{{ system_design_topic.topic }}', 'system_design', 'topic')">
                ‚úÖ Mark Complete
            </button>
            <button class="complete-btn" id="system_design-finish-early-btn" style="display: none; background: #28a745;" onclick="console.log('Button clicked!'); finishEarlyAndMarkComplete('system_design', '{{ system_design_topic.topic }}')" title="Complete this topic before the timer expires. Shows you finished within the estimated time - great for interview skills!">
                ‚è±Ô∏è Finish Early & Mark Complete
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if due_reviews %}
    <div class="section">
        <h2>üîÑ Due Reviews</h2>
        {% for review in due_reviews %}
        <div class="review" id="review-{{ loop.index }}">
            <h4>{{ review.track.replace('_', ' ') | title }}: {{ review.topic }} ({{ review.review_type }} review)</h4>
            <p>Originally completed: {{ review.scheduled_date }}</p>

            {% if review.problems or review.practice_questions %}
            <div class="review-practice-section" id="practice-section-{{ loop.index }}" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                {% if review.track == 'coding' %}
                <h5>üéØ Practice Problems</h5>
                {% else %}
                <h5>üéØ Practice Questions</h5>
                {% endif %}

                {% if review.benchmarks %}
                <div class="time-benchmarks" style="margin: 10px 0; font-size: 14px; color: #666;">
                    <strong>Time Benchmarks:</strong>
                    Base time: {{ "%.0f"|format(review.benchmarks.total_base_minutes) }} min |
                    Rating 5: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[5].max_minutes) }} min |
                    Rating 4: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[4].max_minutes) }} min |
                    Rating 3: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[3].max_minutes) }} min
                </div>
                {% endif %}

                <div class="practice-controls" style="margin: 10px 0;">
                    {% if review.track == 'coding' %}
                    <button class="practice-btn" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px;"
                            onclick="startReviewPractice({{ loop.index }}, '{{ review.topic }}', '{{ review.track }}')">
                        üèÉ Start Review Practice
                    </button>
                    {% else %}
                    <button class="practice-btn" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px;"
                            onclick="startSystemDesignPractice({{ loop.index }}, '{{ review.topic }}', '{{ review.track }}', '{{ review.review_type }}')">
                        üèÉ Start System Design Practice
                    </button>
                    {% endif %}
                    <span class="practice-timer" id="practice-timer-{{ loop.index }}" style="font-weight: bold; display: none;">‚è±Ô∏è 00:00</span>
                    <button class="practice-btn" id="stop-practice-{{ loop.index }}" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; display: none;"
                            onclick="stopReviewPractice({{ loop.index }})">
                        ‚èπÔ∏è Stop Practice
                    </button>
                </div>

                {% if review.track == 'coding' %}
                <div class="problems-list" id="problems-list-{{ loop.index }}">
                    {% for problem in review.problems %}
                    <div class="problem-item" style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <a href="{{ problem.url }}" target="_blank" class="problem-link" style="color: #007bff; text-decoration: none;">
                                #{{ problem.number }} - {{ problem.title }}
                            </a>
                            <span class="difficulty difficulty-{{ problem.difficulty.lower() }}" style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                {{ problem.difficulty }}
                            </span>
                        </div>
                        <p style="margin: 4px 0; color: #666; font-size: 14px;">{{ problem.description }}</p>
                        <div class="problem-timer-section" id="problem-timer-{{ loop.index }}-{{ loop.index0 }}" style="display: none; margin-top: 8px;">
                            <button class="complete-problem-btn" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px;"
                                    onclick="markProblemComplete({{ loop.index }}, {{ loop.index0 }})">
                                ‚úÖ Mark Problem Complete
                            </button>
                            <span class="problem-time" style="margin-left: 10px; font-size: 12px; color: #666;">Time: <span id="problem-time-{{ loop.index }}-{{ loop.index0 }}">0 min</span></span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="questions-list" id="questions-list-{{ loop.index }}">
                    {% for question in review.practice_questions %}
                    <div class="question-item" style="margin: 12px 0; padding: 12px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <div class="question-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span class="question-type" style="background: #{{ 'e3f2fd' if question.type == 'estimation' else 'fff3e0' if question.type == 'concepts' else 'f3e5f5' if question.type == 'tradeoffs' else 'e8f5e8' }}; color: #{{ '1976d2' if question.type == 'estimation' else 'f57c00' if question.type == 'concepts' else '7b1fa2' if question.type == 'tradeoffs' else '388e3c' }}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                                {{ question.type }}
                            </span>
                            <span class="question-number" style="color: #666; font-size: 12px;">Q{{ loop.index0 + 1 }}</span>
                        </div>
                        <div class="question-text" style="margin: 8px 0; font-weight: 500; color: #333;">
                            {{ question.question }}
                        </div>
                        <div class="answer-section" id="answer-section-{{ loop.index }}-{{ loop.index0 }}" style="display: none; margin-top: 12px;">
                            <textarea id="answer-{{ loop.index }}-{{ loop.index0 }}"
                                    style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
                                    placeholder="Enter your answer here..."></textarea>
                            <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <button class="mark-answered-btn" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; font-size: 12px;"
                                        onclick="markQuestionAnswered({{ loop.index }}, {{ loop.index0 }})">
                                    ‚úÖ Mark Answered
                                </button>
                                <span class="answer-time" style="font-size: 12px; color: #666;">Time: <span id="answer-time-{{ loop.index }}-{{ loop.index0 }}">0 min</span></span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="practice-summary" id="practice-summary-{{ loop.index }}" style="display: none; margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <h6>üéØ Practice Summary</h6>
                    <p>Total Time: <span id="total-practice-time-{{ loop.index }}">0</span> minutes</p>
                    <p>Suggested Rating: <strong id="suggested-rating-{{ loop.index }}">-</strong></p>
                    <div style="margin: 8px 0;">
                        <label style="font-size: 14px;">Adjust your rating if needed:</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="rating">
                <label>How well do you remember? (1-5):</label>
                <select id="review-rating-{{ loop.index }}">
                    <option value="1">1 - Completely forgot</option>
                    <option value="2">2 - Vague memory</option>
                    <option value="3" selected>3 - Some memory</option>
                    <option value="4">4 - Good memory</option>
                    <option value="5">5 - Perfect recall</option>
                </select>
                <span id="rating-suggestion-{{ loop.index }}" style="margin-left: 10px; color: #007bff; font-weight: bold; display: none;"></span>
            </div>
            <textarea id="review-notes-{{ loop.index }}" class="notes" placeholder="Review notes..."></textarea>
            <button class="complete-btn" onclick="markCompleteWithPracticeData('{{ review.topic }}', '{{ review.track }}', 'review', {{ loop.index }})">
                ‚úÖ Review Complete
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <script>
        async function markComplete(topic, track, type, reviewIndex = null) {
            // For reviews, delegate to the enhanced function
            if (type === 'review') {
                return markCompleteWithPracticeData(topic, track, type, reviewIndex);
            }

            console.log(`markComplete called with topic: ${topic}, track: ${track}, type: ${type}`);
            let rating, notes;

            let elementId;
            if (type === 'topic') {
                elementId = `${track}-topic`;
                const ratingSelect = document.getElementById(`${track}-rating`);
                const notesTextarea = document.getElementById(`${track}-notes`);

                console.log(`Looking for elements: ${track}-rating, ${track}-notes`);
                console.log(`Rating element found: ${ratingSelect ? 'YES' : 'NO'}`);
                console.log(`Notes element found: ${notesTextarea ? 'YES' : 'NO'}`);

                if (!ratingSelect || !notesTextarea) {
                    console.error(`Missing form elements for ${track}`);
                    return;
                }

                rating = parseInt(ratingSelect.value);
                notes = notesTextarea.value;
                console.log(`Rating: ${rating}, Notes: ${notes}`);
            }

            // Disable the section immediately to prevent double-submission
            const element = document.getElementById(elementId);
            console.log(`Looking for element: ${elementId}`);
            console.log(`Element found: ${element ? 'YES' : 'NO'}`);

            if (!element) {
                console.error(`Could not find element with ID: ${elementId}`);
                return;
            }

            element.style.pointerEvents = 'none';
            const button = element.querySelector('.complete-btn');
            console.log(`Button found: ${button ? 'YES' : 'NO'}`);

            if (!button) {
                console.error(`Could not find .complete-btn within element ${elementId}`);
                return;
            }

            button.textContent = '‚è≥ Saving...';
            button.style.background = '#6c757d';

            try {
                const response = await fetch('/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        track: track,
                        type: type,
                        rating: rating,
                        notes: notes,
                        completed_on_time: await getCompletionTimingStatus(track)
                    })
                });

                if (response.ok) {
                    // Replace the form with a completion message
                    const completionMessage = document.createElement('div');
                    completionMessage.className = 'completed-message';
                    completionMessage.innerHTML = `
                        <h4>‚úÖ ${topic} Complete!</h4>
                        <p>Rating: ${rating}/5 | Notes: ${notes || 'No notes'}</p>
                        <p><em>Great job! Keep up the momentum! üöÄ</em></p>
                    `;

                    // Hide input elements and show completion message
                    const ratingDiv = element.querySelector('.rating');
                    const notesTextarea = element.querySelector('.notes');
                    const button = element.querySelector('.complete-btn');

                    if (ratingDiv) ratingDiv.style.display = 'none';
                    if (notesTextarea) notesTextarea.style.display = 'none';
                    if (button) button.style.display = 'none';

                    element.appendChild(completionMessage);
                    element.classList.add('completed-section');
                } else {
                    // Re-enable on error
                    element.style.pointerEvents = 'auto';
                    button.textContent = '‚úÖ Mark Complete';
                    button.style.background = '#28a745';
                    alert('‚ùå Error saving completion. Please try again.');
                }
            } catch (error) {
                // Re-enable on error
                const element = document.getElementById(elementId);
                element.style.pointerEvents = 'auto';
                const button = element.querySelector('.complete-btn');
                button.textContent = '‚úÖ Mark Complete';
                button.style.background = '#28a745';
                alert('‚ùå Network error. Please check your connection and try again.');
                console.error(error);
            }
        }

        // Server-synced Pomodoro Timer functionality
        let updateInterval = null;
        let currentTrack = null;

        // Initialize timer state sync when page loads
        let syncInterval = null;
        let serverUnavailable = false;

        document.addEventListener('DOMContentLoaded', function() {
            syncTimerState();
            // Start with 2-second intervals
            startTimerSync();
            // Clean up old practice sessions from localStorage
            cleanupOldPracticeSessions();
        });

        function cleanupOldPracticeSessions() {
            const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            const now = Date.now();

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('practice_session_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.timestamp && (now - data.timestamp) > MAX_AGE) {
                            localStorage.removeItem(key);
                            console.log('Cleaned up old practice session:', key);
                        }
                    } catch (e) {
                        // Invalid data, remove it
                        localStorage.removeItem(key);
                        console.log('Removed invalid practice session data:', key);
                    }
                }
            }
        }

        function startTimerSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncTimerState, 2000);
        }

        function stopTimerSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        async function syncTimerState() {
            try {
                const response = await fetch('/api/timer/state');
                if (response.ok) {
                    const state = await response.json();
                    updateTimerDisplay(state);

                    // Server is back online
                    if (serverUnavailable) {
                        console.log('Timer sync: Server connection restored');
                        serverUnavailable = false;
                    }
                } else {
                    // Server responded but with an error
                    console.warn('Timer state API returned error:', response.status);
                }
            } catch (error) {
                // Network error - server might not be running
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    if (!serverUnavailable) {
                        console.warn('Timer sync: Server not reachable, timer features disabled');
                        serverUnavailable = true;
                        // Disable timer functionality gracefully
                        hideAllTimers();
                    }
                } else {
                    console.error('Error syncing timer state:', error);
                }
            }
        }

        function updateTimerDisplay(state) {
            const allTracks = ['coding', 'system_design'];

            if (!state.active) {
                // No active timer - hide all timer sections and reset button states
                hideAllTimers();
                updateStartButtonStates(null);
                return;
            }

            // Show timer for the active track
            const track = state.track;
            const pomodoroSection = document.getElementById(`${track}-pomodoro`);
            const startButton = document.querySelector(`#${track}-topic .start-timer-btn`);
            const timerDisplay = document.getElementById(`${track}-timer`);
            const pauseButton = document.getElementById(`${track}-pause-btn`);
            const completeBtn = document.getElementById(`${track}-complete-btn`);
            const finishEarlyBtn = document.getElementById(`${track}-finish-early-btn`);

            if (!pomodoroSection || !timerDisplay) return;

            // Show timer section and hide start button
            pomodoroSection.style.display = 'block';
            if (startButton) startButton.style.display = 'none';

            // Update timer display
            if (state.remaining > 0) {
                const totalSeconds = Math.floor(state.remaining);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerDisplay.textContent = timeText;
                timerDisplay.style.color = '';

                // Update button states
                if (pauseButton) {
                    if (state.paused) {
                        pauseButton.innerHTML = '‚ñ∂Ô∏è Resume';
                        pauseButton.className = 'timer-btn';
                    } else {
                        pauseButton.innerHTML = '‚è∏Ô∏è Pause';
                        pauseButton.className = 'timer-btn pause';
                    }
                }

                // Show finish early button, hide complete button
                if (completeBtn) completeBtn.style.display = 'none';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'inline-block';
            } else {
                // Timer expired
                timerDisplay.textContent = "00:00";
                timerDisplay.style.color = '#28a745';

                // Show complete button, hide finish early button
                if (completeBtn) completeBtn.style.display = 'inline-block';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'none';

                // Show completion notification once
                if (currentTrack !== track) {
                    alert(`üéâ Pomodoro complete! Great focus session on ${track.replace('_', ' ')}!`);
                    currentTrack = track;
                }
            }

            // Hide timers for other tracks and update their start button states
            for (const otherTrack of allTracks) {
                if (otherTrack !== track) {
                    const otherPomodoroSection = document.getElementById(`${otherTrack}-pomodoro`);
                    const otherStartButton = document.querySelector(`#${otherTrack}-topic .start-timer-btn`);
                    if (otherPomodoroSection) otherPomodoroSection.style.display = 'none';
                    if (otherStartButton) otherStartButton.style.display = 'inline-block';
                }
            }

            // Update start button states to show which has active timer
            updateStartButtonStates(state);
        }

        function updateStartButtonStates(activeState) {
            const allTracks = ['coding', 'system_design'];

            for (const track of allTracks) {
                const startButton = document.querySelector(`#${track}-topic .start-timer-btn:not([title*="Template"])`);
                if (!startButton) continue;

                if (!activeState || !activeState.active) {
                    // No active timer - reset to normal state
                    startButton.innerHTML = 'üçÖ Start Timer';
                    startButton.style.backgroundColor = '#17a2b8';
                    startButton.title = `Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.`;
                } else if (activeState.track === track) {
                    // This track has the active timer - button should be hidden by timer display
                    startButton.style.display = 'none';
                } else {
                    // Another track has active timer - show warning state
                    const activeTrackName = activeState.track.replace('_', ' ');
                    const remainingMins = Math.floor(activeState.remaining / 60);
                    const remainingSecs = Math.floor(activeState.remaining % 60);
                    const timeLeft = `${remainingMins}:${remainingSecs.toString().padStart(2, '0')}`;

                    startButton.innerHTML = `‚ö†Ô∏è Timer Active (${timeLeft})`;
                    startButton.style.backgroundColor = '#ffc107';
                    startButton.style.color = '#212529';
                    startButton.title = `Another timer is active: ${activeTrackName} - "${activeState.topic}" (${timeLeft} remaining). Click to switch timers.`;
                }
            }
        }

        function hideAllTimers() {
            const allTracks = ['coding', 'system_design'];
            for (const track of allTracks) {
                const pomodoroSection = document.getElementById(`${track}-pomodoro`);
                const startButton = document.querySelector(`#${track}-topic .start-timer-btn`);
                const completeBtn = document.getElementById(`${track}-complete-btn`);
                const finishEarlyBtn = document.getElementById(`${track}-finish-early-btn`);

                if (pomodoroSection) pomodoroSection.style.display = 'none';
                if (startButton) {
                    startButton.style.display = 'inline-block';
                    // Reset button appearance
                    startButton.innerHTML = 'üçÖ Start Timer';
                    startButton.style.backgroundColor = '#17a2b8';
                    startButton.style.color = 'white';
                }
                if (completeBtn) completeBtn.style.display = 'inline-block';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'none';
            }
            currentTrack = null;
        }

        async function startPomodoro(track, minutes) {
            console.log(`Starting Pomodoro for track: ${track}, minutes: ${minutes}`);

            // Check if server is available
            if (serverUnavailable) {
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            try {
                // First check if there's already an active timer
                const stateResponse = await fetch('/api/timer/state');
                if (stateResponse.ok) {
                    const currentState = await stateResponse.json();

                    // If there's an active timer for a different track/topic, ask for confirmation
                    if (currentState.active && currentState.track !== track) {
                        const remainingMins = Math.floor(currentState.remaining / 60);
                        const remainingSecs = Math.floor(currentState.remaining % 60);
                        const timeLeft = `${remainingMins}:${remainingSecs.toString().padStart(2, '0')}`;

                        const currentTopicName = currentState.topic || 'Unknown Topic';
                        const newTopicName = getTopicName(track);

                        const confirmed = confirm(
                            `‚ö†Ô∏è You already have an active timer running!\n\n` +
                            `Current: ${currentState.track.replace('_', ' ')} - "${currentTopicName}"\n` +
                            `Time remaining: ${timeLeft}\n\n` +
                            `Do you want to stop it and start a new timer for:\n` +
                            `"${newTopicName}" (${minutes} minutes)?\n\n` +
                            `Click OK to replace, Cancel to keep current timer.`
                        );

                        if (!confirmed) {
                            // User chose to keep current timer, scroll to it
                            scrollToActiveTimer(currentState.track);
                            return;
                        }
                    }
                }

                const response = await fetch('/api/timer/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        track: track,
                        topic: getTopicName(track),
                        duration: minutes
                    })
                });

                if (response.ok) {
                    // Timer started successfully, sync will update display
                    await syncTimerState();

                    // Scroll to timer
                    const pomodoroSection = document.getElementById(`${track}-pomodoro`);
                    if (pomodoroSection) {
                        pomodoroSection.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    alert('Error starting timer. Please try again.');
                }
            } catch (error) {
                console.error('Error starting timer:', error);
                alert('Network error starting timer. Please try again.');
            }
        }

        function scrollToActiveTimer(track) {
            const pomodoroSection = document.getElementById(`${track}-pomodoro`);
            if (pomodoroSection && pomodoroSection.style.display !== 'none') {
                pomodoroSection.scrollIntoView({ behavior: 'smooth' });
                // Add a brief highlight effect
                pomodoroSection.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    pomodoroSection.style.backgroundColor = '';
                }, 2000);
            }
        }

        async function pauseTimer(track) {
            // Check if server is available
            if (serverUnavailable) {
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            try {
                // First get current timer state to determine if we should pause or resume
                const stateResponse = await fetch('/api/timer/state');
                if (!stateResponse.ok) {
                    alert('Error getting timer state. Please try again.');
                    return;
                }

                const currentState = await stateResponse.json();

                // Determine which endpoint to call based on current state
                const endpoint = currentState.paused ? '/api/timer/resume' : '/api/timer/pause';
                const action = currentState.paused ? 'resuming' : 'pausing';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Timer action successful, sync will update display
                    await syncTimerState();
                } else {
                    alert(`Error ${action} timer. Please try again.`);
                }
            } catch (error) {
                console.error('Error with timer:', error);
                alert('Network error with timer. Please try again.');
            }
        }

        async function stopTimer(track) {
            // Check if server is available
            if (serverUnavailable) {
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            try {
                const response = await fetch('/api/timer/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Timer stopped successfully, sync will update display
                    await syncTimerState();
                } else {
                    alert('Error stopping timer. Please try again.');
                }
            } catch (error) {
                console.error('Error stopping timer:', error);
                alert('Network error stopping timer. Please try again.');
            }
        }

        function getTopicName(track) {
            // Extract topic name from the page
            const topicElement = document.querySelector(`#${track}-topic h3`);
            if (topicElement) {
                const text = topicElement.textContent;
                // Extract topic name after the prefix (e.g., "üíª Coding: Topic Name")
                const colonIndex = text.indexOf(':');
                if (colonIndex !== -1) {
                    return text.substring(colonIndex + 1).trim();
                }
            }
            return 'Unknown Topic';
        }

        // Helper function to determine completion timing status
        async function getCompletionTimingStatus(track) {
            try {
                const response = await fetch('/api/timer/state');
                if (response.ok) {
                    const state = await response.json();
                    if (!state.active || state.track !== track) {
                        return null; // No timer for this track
                    }
                    if (state.remaining <= 0) {
                        return false; // Timer expired - completed over time
                    }
                    return true; // Timer still running - completed early
                }
            } catch (error) {
                console.error('Error checking timer status:', error);
            }
            return null;
        }

        // Function for finishing early with timer
        async function finishEarlyAndMarkComplete(track, topic) {
            console.log(`finishEarlyAndMarkComplete called with track: ${track}, topic: ${topic}`);

            try {
                // Stop the timer first
                await stopTimer(track);

                // Call the regular markComplete function which will handle timing status
                await markComplete(topic, track, 'topic');
                console.log(`markComplete completed successfully for ${track}`);
            } catch (error) {
                console.error(`Error in finishEarlyAndMarkComplete for ${track}:`, error);
            }
        }

        // Review Practice Timer System
        let reviewPracticeTimers = {}; // Track active practice sessions
        let systemDesignSessions = {}; // Track system design practice sessions
        let problemStartTimes = {}; // Track individual problem start times
        let completedProblems = {}; // Track completed problems per review

        function startReviewPractice(reviewIndex, topic, track) {
            console.log(`Starting review practice for ${topic} (${track})`);

            // Initialize tracking for this review
            if (!reviewPracticeTimers[reviewIndex]) {
                reviewPracticeTimers[reviewIndex] = {
                    startTime: Date.now(),
                    interval: null,
                    topic: topic,
                    track: track,
                    totalMinutes: 0
                };
                completedProblems[reviewIndex] = [];
            }

            // Show practice controls
            document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'inline';
            document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'inline';

            // Show individual problem timers
            const problemTimers = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-timer-section`);
            problemTimers.forEach((timer, problemIndex) => {
                timer.style.display = 'block';
                // Start timing each problem immediately
                const problemKey = `${reviewIndex}-${problemIndex}`;
                problemStartTimes[problemKey] = Date.now();
            });

            // Start the main timer
            reviewPracticeTimers[reviewIndex].interval = setInterval(() => {
                updateReviewPracticeTimer(reviewIndex);
                updateIndividualProblemTimers(reviewIndex);
            }, 1000);

            // Disable the start button
            const startButton = document.querySelector(`button[onclick*="startReviewPractice(${reviewIndex}"]`);
            if (startButton) {
                startButton.disabled = true;
                startButton.textContent = 'üèÉ Practice In Progress...';
            }
        }

        function updateReviewPracticeTimer(reviewIndex) {
            const timer = reviewPracticeTimers[reviewIndex];
            if (!timer) return;

            const elapsed = Date.now() - timer.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById(`practice-timer-${reviewIndex}`).textContent =
                `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timer.totalMinutes = minutes + (seconds / 60);
        }

        function updateIndividualProblemTimers(reviewIndex) {
            const problemTimers = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-timer-section`);
            problemTimers.forEach((timer, problemIndex) => {
                const problemKey = `${reviewIndex}-${problemIndex}`;
                const startTime = problemStartTimes[problemKey];
                if (!startTime) return;

                // Only update if problem not yet completed
                const completeButton = timer.querySelector('.complete-problem-btn');
                if (completeButton && !completeButton.disabled) {
                    const elapsed = Date.now() - startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);

                    const timeDisplay = document.getElementById(`problem-time-${reviewIndex}-${problemIndex}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            });
        }

        function markProblemComplete(reviewIndex, problemIndex) {
            console.log(`Marking problem ${problemIndex} complete for review ${reviewIndex}`);

            const problemKey = `${reviewIndex}-${problemIndex}`;

            // Use existing start time (should already be set when practice started)
            const startTime = problemStartTimes[problemKey];
            if (!startTime) {
                console.warn(`No start time found for problem ${problemKey}, using current time`);
                problemStartTimes[problemKey] = Date.now();
            }

            const elapsed = Date.now() - problemStartTimes[problemKey];
            const minutes = Math.round(elapsed / 60000);

            // Update the problem time display to final time
            document.getElementById(`problem-time-${reviewIndex}-${problemIndex}`).textContent = `${minutes} min`;

            // Mark as completed
            if (!completedProblems[reviewIndex]) {
                completedProblems[reviewIndex] = [];
            }
            completedProblems[reviewIndex].push({
                problemIndex: problemIndex,
                timeMinutes: minutes
            });

            // Disable the button
            const completeButton = document.querySelector(`#problem-timer-${reviewIndex}-${problemIndex} .complete-problem-btn`);
            if (completeButton) {
                completeButton.disabled = true;
                completeButton.textContent = '‚úÖ Completed';
                completeButton.style.background = '#6c757d';
            }

            console.log(`Problem completed in ${minutes} minutes`);
        }

        function stopReviewPractice(reviewIndex) {
            const timer = reviewPracticeTimers[reviewIndex];
            if (!timer) return;

            // Stop the timer
            clearInterval(timer.interval);

            // Calculate final results
            const totalMinutes = Math.round(timer.totalMinutes);

            // Get benchmark data from the page (we'll need to pass this from the backend)
            const benchmarkElements = document.querySelector(`#practice-section-${reviewIndex} .time-benchmarks`);
            let suggestedRating = 3; // Default

            // Simple rating calculation based on completion
            const problemCount = completedProblems[reviewIndex] ? completedProblems[reviewIndex].length : 0;
            const totalProblems = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-item`).length;

            if (problemCount === totalProblems) {
                // All problems completed - base rating on time
                if (totalMinutes <= 30) suggestedRating = 5;
                else if (totalMinutes <= 45) suggestedRating = 4;
                else if (totalMinutes <= 70) suggestedRating = 3;
                else if (totalMinutes <= 100) suggestedRating = 2;
                else suggestedRating = 1;
            } else {
                // Not all problems completed
                const completionRate = problemCount / totalProblems;
                if (completionRate >= 0.8) suggestedRating = 3;
                else if (completionRate >= 0.5) suggestedRating = 2;
                else suggestedRating = 1;
            }

            // Show practice summary
            document.getElementById(`practice-summary-${reviewIndex}`).style.display = 'block';
            document.getElementById(`total-practice-time-${reviewIndex}`).textContent = totalMinutes;
            document.getElementById(`suggested-rating-${reviewIndex}`).textContent = `${suggestedRating} (${getRatingDescription(suggestedRating)})`;

            // Update the rating dropdown and show suggestion
            const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
            ratingSelect.value = suggestedRating;

            const suggestionSpan = document.getElementById(`rating-suggestion-${reviewIndex}`);
            suggestionSpan.textContent = `(Suggested: ${suggestedRating})`;
            suggestionSpan.style.display = 'inline';

            // Hide practice controls
            document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'none';
            document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'none';

            // Re-enable start button
            const startButton = document.querySelector(`button[onclick*="startReviewPractice(${reviewIndex}"]`);
            if (startButton) {
                startButton.disabled = false;
                startButton.textContent = 'üèÉ Start Review Practice';
            }

            console.log(`Review practice completed: ${totalMinutes} minutes, suggested rating: ${suggestedRating}`);
        }

        function getRatingDescription(rating) {
            const descriptions = {
                5: 'Perfect recall',
                4: 'Good memory',
                3: 'Some memory',
                2: 'Vague memory',
                1: 'Completely forgot'
            };
            return descriptions[rating] || 'Unknown';
        }

        // System Design Practice Functions
        async function startSystemDesignPractice(reviewIndex, topic, track, reviewType) {
            console.log(`Starting system design practice for ${topic} (${reviewType})`);

            try {
                // Create session key for this practice session
                const sessionKey = `${track}_${topic}_${reviewType}`.replace(/\s+/g, '_');

                // Check if we have cached questions for this session
                const cachedData = localStorage.getItem(`practice_session_${sessionKey}`);
                let requestBody = {
                    topic: topic,
                    track: track,
                    review_type: reviewType,
                    use_cached: false
                };

                if (cachedData) {
                    const parsedData = JSON.parse(cachedData);
                    requestBody.use_cached = true;
                    requestBody.cached_questions = parsedData.questions;
                    console.log('Using cached questions for', sessionKey);
                }

                // Fetch practice questions and benchmarks
                const response = await fetch('/api/system-design-practice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to load practice questions');
                }

                const data = await response.json();

                // Save questions to localStorage if they're newly generated
                if (!cachedData) {
                    const sessionData = {
                        questions: data.questions,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(`practice_session_${sessionKey}`, JSON.stringify(sessionData));
                    console.log('Saved new questions to localStorage for', sessionKey);
                }

                // Initialize session tracking
                systemDesignSessions[reviewIndex] = {
                    startTime: Date.now(),
                    interval: null,
                    topic: topic,
                    track: track,
                    reviewType: reviewType,
                    questions: data.questions,
                    benchmarks: data.benchmarks,
                    answers: {},
                    questionStartTimes: {},
                    totalMinutes: 0,
                    sessionKey: sessionKey
                };

                // Show practice controls
                document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'inline';
                document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'inline';

                // Show answer sections for all questions and start timing each one
                const answerSections = document.querySelectorAll(`#practice-section-${reviewIndex} .answer-section`);
                answerSections.forEach((section, questionIndex) => {
                    section.style.display = 'block';
                    // Start timing each question immediately
                    const questionKey = `${reviewIndex}-${questionIndex}`;
                    systemDesignSessions[reviewIndex].questionStartTimes[questionKey] = Date.now();
                });

                // Start the main timer
                systemDesignSessions[reviewIndex].interval = setInterval(() => {
                    updateSystemDesignTimer(reviewIndex);
                    updateIndividualQuestionTimers(reviewIndex);
                }, 1000);

                // Disable the start button
                const startButton = document.querySelector(`button[onclick*="startSystemDesignPractice(${reviewIndex}"]`);
                if (startButton) {
                    startButton.disabled = true;
                    startButton.textContent = 'üèÉ Practice In Progress...';
                }

                console.log(`System design practice started with ${data.questions.length} questions`);

            } catch (error) {
                console.error('Error starting system design practice:', error);
                alert('Failed to start practice session. Please try again.');
            }
        }

        function updateSystemDesignTimer(reviewIndex) {
            const session = systemDesignSessions[reviewIndex];
            if (!session) return;

            const elapsed = Date.now() - session.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById(`practice-timer-${reviewIndex}`).textContent =
                `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            session.totalMinutes = minutes + (seconds / 60);
        }

        function updateIndividualQuestionTimers(reviewIndex) {
            const session = systemDesignSessions[reviewIndex];
            if (!session) return;

            const answerSections = document.querySelectorAll(`#practice-section-${reviewIndex} .answer-section`);
            answerSections.forEach((section, questionIndex) => {
                const questionKey = `${reviewIndex}-${questionIndex}`;
                const startTime = session.questionStartTimes[questionKey];
                if (!startTime) return;

                // Only update if question not yet answered
                const answerButton = section.querySelector('.mark-answered-btn');
                if (answerButton && !answerButton.disabled) {
                    const elapsed = Date.now() - startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);

                    const timeDisplay = document.getElementById(`answer-time-${reviewIndex}-${questionIndex}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            });
        }

        function markQuestionAnswered(reviewIndex, questionIndex) {
            console.log(`markQuestionAnswered called with reviewIndex: ${reviewIndex}, questionIndex: ${questionIndex}`);

            const session = systemDesignSessions[reviewIndex];
            if (!session) {
                console.error(`No session found for reviewIndex: ${reviewIndex}`);
                return;
            }

            const questionKey = `${reviewIndex}-${questionIndex}`;
            const answerTextarea = document.getElementById(`answer-${reviewIndex}-${questionIndex}`);

            if (!answerTextarea) {
                console.error(`No textarea found with ID: answer-${reviewIndex}-${questionIndex}`);
                return;
            }

            const answer = answerTextarea.value.trim();

            if (!answer) {
                alert('Please enter an answer before marking as complete.');
                return;
            }

            // Record the answer
            const questionId = session.questions[questionIndex]?.id || questionKey;
            session.answers[questionId] = answer;

            // Calculate time for this question (should already be started)
            const startTime = session.questionStartTimes[questionKey];
            if (!startTime) {
                console.warn(`No start time found for question ${questionKey}, using current time`);
                session.questionStartTimes[questionKey] = Date.now();
            }

            const elapsed = Date.now() - session.questionStartTimes[questionKey];
            const minutes = Math.round(elapsed / 60000);

            // Update display to final time
            const timeDisplay = document.getElementById(`answer-time-${reviewIndex}-${questionIndex}`);
            if (timeDisplay) {
                timeDisplay.textContent = `${minutes} min`;
            } else {
                console.error(`No time display found with ID: answer-time-${reviewIndex}-${questionIndex}`);
            }

            // Disable the button
            const answerButton = document.querySelector(`#answer-section-${reviewIndex}-${questionIndex} .mark-answered-btn`);
            if (answerButton) {
                answerButton.disabled = true;
                answerButton.textContent = '‚úÖ Answered';
                answerButton.style.background = '#6c757d';
                console.log(`Question ${questionIndex + 1} answered in ${minutes} minutes`);
            } else {
                console.error(`No answer button found with selector: #answer-section-${reviewIndex}-${questionIndex} .mark-answered-btn`);
            }
        }

        async function stopSystemDesignPractice(reviewIndex) {
            const session = systemDesignSessions[reviewIndex];
            if (!session) return;

            // Stop the timer
            clearInterval(session.interval);

            // Prepare session data for rating calculation
            const sessionData = {
                total_time: Math.round(session.totalMinutes),
                answers: session.answers,
                questions: session.questions,
                self_assessment: {} // Will be filled by user if needed
            };

            try {
                // Calculate suggested rating
                const response = await fetch('/api/calculate-system-design-rating', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_data: sessionData,
                        benchmarks: session.benchmarks
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const suggestedRating = result.suggested_rating;

                    // Show practice summary
                    document.getElementById(`practice-summary-${reviewIndex}`).style.display = 'block';
                    document.getElementById(`total-practice-time-${reviewIndex}`).textContent = sessionData.total_time;
                    document.getElementById(`suggested-rating-${reviewIndex}`).textContent =
                        `${suggestedRating} (${getRatingDescription(suggestedRating)})`;

                    // Update the rating dropdown and show suggestion
                    const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
                    ratingSelect.value = suggestedRating;

                    const suggestionSpan = document.getElementById(`rating-suggestion-${reviewIndex}`);
                    suggestionSpan.textContent = `(Suggested: ${suggestedRating})`;
                    suggestionSpan.style.display = 'inline';

                    // Store session data for completion
                    session.sessionData = sessionData;

                    console.log(`System design practice completed: ${sessionData.total_time} minutes, suggested rating: ${suggestedRating}`);
                } else {
                    console.error('Failed to calculate rating');
                }

            } catch (error) {
                console.error('Error calculating rating:', error);
            }

            // Hide practice controls
            document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'none';
            document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'none';

            // Clean up localStorage for this session when practice is stopped
            const session = systemDesignSessions[reviewIndex];
            if (session && session.sessionKey) {
                localStorage.removeItem(`practice_session_${session.sessionKey}`);
                console.log('Cleared localStorage for stopped session:', session.sessionKey);
            }

            // Re-enable start button
            const startButton = document.querySelector(`button[onclick*="startSystemDesignPractice(${reviewIndex}"]`);
            if (startButton) {
                startButton.disabled = false;
                startButton.textContent = 'üèÉ Start System Design Practice';
            }
        }

        // Enhanced markComplete function to include practice data
        async function markCompleteWithPracticeData(topic, track, type, reviewIndex = null) {
            // Get base completion data
            let rating, notes;
            let practiceData = null;

            if (type === 'review' && reviewIndex !== null) {
                const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
                const notesTextarea = document.getElementById(`review-notes-${reviewIndex}`);
                rating = parseInt(ratingSelect.value);
                notes = notesTextarea.value;

                // Include practice data if available
                const timer = reviewPracticeTimers[reviewIndex];
                if (timer && completedProblems[reviewIndex]) {
                    practiceData = {
                        practice_time: Math.round(timer.totalMinutes),
                        problem_times: completedProblems[reviewIndex],
                        suggested_rating: parseInt(document.getElementById(`suggested-rating-${reviewIndex}`).textContent.charAt(0))
                    };
                }
            }

            // Prepare request data
            const requestData = {
                topic: topic,
                track: track,
                type: type,
                rating: rating,
                notes: notes
            };

            // Add practice data if available
            if (practiceData) {
                Object.assign(requestData, practiceData);
            }

            // Disable the review section to prevent double-submission
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (reviewElement) {
                reviewElement.style.pointerEvents = 'none';
                const button = reviewElement.querySelector('.complete-btn');
                if (button) {
                    button.textContent = '‚è≥ Saving...';
                    button.style.background = '#6c757d';
                }
            }

            // Make the completion request
            try {
                const response = await fetch('/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    console.log('Review completed successfully with practice data');

                    // Clean up localStorage for system design sessions
                    const systemDesignSession = systemDesignSessions[reviewIndex];
                    if (systemDesignSession && systemDesignSession.sessionKey) {
                        localStorage.removeItem(`practice_session_${systemDesignSession.sessionKey}`);
                        console.log('Cleared localStorage for completed session:', systemDesignSession.sessionKey);
                    }

                    // Show completion summary instead of immediate reload
                    showReviewCompletionSummary(reviewIndex, topic, track, rating, notes, practiceData);

                    // Clean up practice data
                    if (reviewIndex !== null) {
                        delete reviewPracticeTimers[reviewIndex];
                        delete completedProblems[reviewIndex];
                        delete systemDesignSessions[reviewIndex];
                    }
                } else {
                    console.error('Failed to complete review');
                    // Re-enable on error
                    if (reviewElement) {
                        reviewElement.style.pointerEvents = 'auto';
                        const button = reviewElement.querySelector('.complete-btn');
                        if (button) {
                            button.textContent = '‚úÖ Review Complete';
                            button.style.background = '#28a745';
                        }
                    }
                    alert('‚ùå Error saving completion. Please try again.');
                }
            } catch (error) {
                console.error('Error completing review:', error);
                // Re-enable on error
                if (reviewElement) {
                    reviewElement.style.pointerEvents = 'auto';
                    const button = reviewElement.querySelector('.complete-btn');
                    if (button) {
                        button.textContent = '‚úÖ Review Complete';
                        button.style.background = '#28a745';
                    }
                }
                alert('‚ùå Network error. Please check your connection and try again.');
            }
        }

        function showReviewCompletionSummary(reviewIndex, topic, track, rating, notes, practiceData) {
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (!reviewElement) return;

            // Create completion summary
            let summaryHTML = `
                <div class="completed-message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>‚úÖ ${track.charAt(0).toUpperCase() + track.slice(1)}: ${topic} Review Complete!</h4>
                    <p><strong>Rating:</strong> ${rating}/5 (${getRatingDescription(rating)})</p>
                    ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ''}
            `;

            // Add practice summary if available
            if (practiceData) {
                summaryHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                        <h5>üéØ Practice Session Results:</h5>
                        <p><strong>Total Practice Time:</strong> ${practiceData.practice_time} minutes</p>
                        <p><strong>Problems Completed:</strong> ${practiceData.problem_times.length}</p>
                `;

                if (practiceData.problem_times.length > 0) {
                    summaryHTML += '<p><strong>Individual Problem Times:</strong></p><ul>';
                    practiceData.problem_times.forEach((problem, idx) => {
                        summaryHTML += `<li>Problem ${idx + 1}: ${problem.timeMinutes} min</li>`;
                    });
                    summaryHTML += '</ul>';
                }
                summaryHTML += '</div>';
            }

            summaryHTML += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            üîÑ Refresh Dashboard
                        </button>
                        <button onclick="hideCompletionSummary(${reviewIndex})" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ‚ùå Dismiss
                        </button>
                    </div>
                    <p style="margin-top: 10px;"><em>Great job! Keep up the momentum! üöÄ</em></p>
                </div>
            `;

            // Hide the form elements and show summary
            const formElements = reviewElement.querySelectorAll('.rating, .notes, .complete-btn, .review-practice-section');
            formElements.forEach(el => el.style.display = 'none');

            reviewElement.insertAdjacentHTML('beforeend', summaryHTML);
        }

        function hideCompletionSummary(reviewIndex) {
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (reviewElement) {
                // Just hide the entire review element
                reviewElement.style.display = 'none';
            }
        }

        // Debug: Test if startPomodoro function is accessible
        console.log('startPomodoro function available:', typeof startPomodoro);

        // Make startPomodoro globally accessible in case of scope issues
        window.startPomodoro = startPomodoro;
    </script>
</body>
</html>