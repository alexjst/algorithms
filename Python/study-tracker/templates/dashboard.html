<!DOCTYPE html>
<html>
<head>
    <title>Study Tracker - Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">

    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="highlight-dark" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

    <style>
        /* Theme CSS Variables */
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --bg-header: #f0f8ff;
            --bg-review: #fff3cd;
            --bg-practice: #fff9e6;
            --border-practice: #ffc107;
            --text-practice-heading: #856404;
            --text-practice: #333333;
            --border-question-item: #f0f0f0;
            --bg-review-practice: #f8f9fa;
            --border-review-practice: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #666;
            --border-color: #ddd;
            --shadow: rgba(0, 0, 0, 0.08);
            --nav-hover: #f1f3f5;
            --nav-active-bg: #e7f3ff;
            --nav-active-color: #007bff;
            --code-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --bg-header: #2c3e50;
            --bg-review: #4a4a2d;
            --bg-practice: #2d2d20;
            --border-practice: #d4a017;
            --text-practice-heading: #ffd700;
            --text-practice: #ffffff;
            --border-question-item: #555;
            --bg-review-practice: #2d2d2d;
            --border-review-practice: #17a2b8;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --shadow: rgba(0, 0, 0, 0.3);
            --nav-hover: #3a3a3a;
            --nav-active-bg: #1e3a5f;
            --nav-active-color: #66b3ff;
            --code-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .header { background: var(--bg-header); padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .section { border: 1px solid var(--border-color); padding: 15px; margin: 10px 0; border-radius: 5px; background: var(--bg-secondary); }
        .topic { background: var(--bg-tertiary); padding: 10px; margin: 5px 0; border-radius: 3px; }
        .review { background: var(--bg-review); padding: 10px; margin: 5px 0; border-radius: 3px; }
        .complete-btn { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .complete-btn:hover { background: #218838; }
        .rating { margin: 5px 0; }
        .notes { width: 100%; height: 60px; margin: 5px 0; }
        /* New Navigation Bar Styles */
        .nav-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            background-color: var(--bg-secondary);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow);
            margin-bottom: 30px;
        }
        .nav-link {
            display: flex;
            align-items: center;
            white-space: nowrap;
            text-decoration: none;
            color: var(--text-primary);
            padding: 10px 20px;
            margin: 5px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: var(--nav-hover);
            color: var(--nav-active-color);
        }
        .nav-link.active {
            background-color: var(--nav-active-bg);
            color: var(--nav-active-color);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            background-color: var(--nav-hover);
            transform: scale(1.05);
        }
        .time-estimate { color: var(--text-secondary); font-size: 0.9em; }
        .detailed-content { background: var(--bg-tertiary); padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .detailed-content pre { white-space: pre-wrap; margin: 0; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; background: var(--code-bg); padding: 10px; border-radius: 4px; overflow-x: auto; }
        .detailed-content code { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }
        .notes, .rating select { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .problems-section, .resources-section, .concepts-section, .practice-section { margin: 15px 0; }
        .practice-section { background: var(--bg-practice); color: var(--text-practice); padding: 20px; border-radius: 8px; border-left: 4px solid var(--border-practice); }
        .practice-section p, .practice-section h4 { color: var(--text-practice); }
        .review-practice-section { margin: 15px 0; padding: 15px; background: var(--bg-review-practice); color: var(--text-primary); border-radius: 8px; border-left: 4px solid var(--border-review-practice); }
        .question-category { margin: 15px 0; }
        .question-category h5 { color: var(--text-practice-heading); margin-bottom: 10px; }
        .question-category ul { padding-left: 20px; }
        .question-category li { margin: 8px 0; padding: 5px 0; border-bottom: 1px solid var(--border-question-item); color: var(--text-practice); }
        .problem-item, .resource-item { margin: 10px 0; padding: 10px; border: 1px solid #e9ecef; border-radius: 5px; background: #f8f9fa; }
        .problem-link, .resource-link { color: #007bff; text-decoration: none; font-size: 16px; }
        .problem-link:hover, .resource-link:hover { text-decoration: underline; }
        .difficulty { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }
        .problem-desc, .resource-desc { color: #666; margin: 5px 0 0 0; font-size: 14px; }
        .concepts-section ul { margin: 10px 0; }
        .concepts-section li { margin: 5px 0; }
        .completed-section { opacity: 0.6; pointer-events: none; }
        .completed-section .complete-btn { background: #6c757d; }
        .completed-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        .pomodoro-section { background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffc107; display: none; }
        .pomodoro-timer { font-size: 28px; font-weight: bold; color: #856404; text-align: center; margin: 10px 0; }
        .timer-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin: 5px; cursor: pointer; font-size: 14px; }
        .timer-btn:hover { background: #218838; }
        .timer-btn.pause { background: #ffc107; color: #212529; }
        .timer-btn.pause:hover { background: #e0a800; }
        .timer-btn.stop { background: #dc3545; }
        .timer-btn.stop:hover { background: #c82333; }
        .start-timer-btn { background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-left: 10px; cursor: pointer; font-size: 14px; }
        .start-timer-btn:hover { background: #138496; }
        .template-link { background: #6c757d; color: white; text-decoration: none; padding: 4px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px; }
        .template-link:hover { background: #5a6268; color: white; }
        .practice-question-item { margin-bottom: 15px; }
        .question-text { margin-bottom: 8px; }
        .toggle-answer-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.2s ease;
        }
        .toggle-answer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .answer-text {
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-left: 3px solid #667eea;
            border-radius: 4px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Study Tracker - Day {{ current_day }}</h1>
        <p><strong>Date:</strong> {{ today }}</p>
        <p><strong>Time Remaining Today:</strong> {{ total_time }} minutes</p>
    </div>

    <!-- New Navigation Bar Structure -->
    <div class="nav-container">
        <a href="/" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" title="Go to Dashboard">üìÖ Dashboard</a>
        <a href="/history" class="nav-link {% if active_page == 'history' %}active{% endif %}" title="View Progress History">üìä History</a>
        <a href="/preview" class="nav-link {% if active_page == 'preview' %}active{% endif %}" title="See Upcoming Topics">üîÆ Preview</a>
        <a href="/practice" class="nav-link {% if active_page == 'practice' %}active{% endif %}" title="Practice & Mock Interviews">üéØ Practice</a>
        <a href="/analytics" class="nav-link {% if active_page == 'analytics' %}active{% endif %}" title="Analyze Your Performance">üìà Analytics</a>
        <a href="/curriculum" class="nav-link {% if active_page == 'curriculum' %}active{% endif %}" title="Edit the Curriculum">üìö Curriculum</a>
        <a href="/templates" class="nav-link {% if active_page == 'templates' %}active{% endif %}" title="Coding Patterns & Templates">üîß Templates</a>
        <a href="/system-design" class="nav-link {% if active_page == 'system-design' %}active{% endif %}" title="System Design Templates">üèóÔ∏è System Design</a>
        <a href="/config" class="nav-link {% if active_page == 'config' %}active{% endif %}" title="Configure Your Plan">‚öôÔ∏è Config</a>
        <a href="/help" class="nav-link {% if active_page == 'help' %}active{% endif %}" title="Get Help">‚ùì Help</a>
        <button class="theme-toggle" id="theme-toggle" title="Toggle Dark/Light Mode">üåô</button>
    </div>

    <!-- Day Selector -->
    <div style="text-align: center; margin-bottom: 20px;">
        <label for="day-selector" style="font-weight: bold; margin-right: 10px; color: var(--text-primary);">Jump to Day:</label>
        <select id="day-selector" style="padding: 8px 12px; font-size: 14px; border: 2px solid #007bff; border-radius: 5px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;" onchange="window.location.href='/day/' + this.value">
            <option value="">-- Select Day --</option>
            {% for d in range(1, 29) %}
                <option value="{{ d }}">Day {{ d }}{% if d == current_day %} (Today){% endif %}</option>
            {% endfor %}
        </select>
    </div>

    <div class="section">
        <h2>üß† Today's Learning</h2>

        {% if coding_topic %}
        <div class="topic {% if coding_topic_completed %}completed-section{% endif %}" id="coding-topic">
            <h3>üíª Coding: {{ coding_topic.topic }}
                <a href="/templates#{{ coding_topic.topic.lower().replace(' ', '-').replace('(', '').replace(')', '') }}" target="_blank" class="template-link" title="View code templates and patterns for {{ coding_topic.topic }}">
                    üìñ Template
                </a>
            </h3>
            <p><strong>Activity:</strong> {{ coding_topic.activity }}</p>

            {% if not coding_topic_completed %}
            <p class="time-estimate">‚è±Ô∏è {{ coding_topic.time_estimate }} minutes
                <button class="start-timer-btn" onclick="startPomodoro('coding', {{ coding_topic.time_estimate }})" title="Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.">
                    üçÖ Start Timer
                </button>
            </p>

            <div class="pomodoro-section" id="coding-pomodoro">
                <h4>üçÖ Focus Session</h4>
                <div class="pomodoro-timer" id="coding-timer">{{ coding_topic.time_estimate }}:00</div>
                <div style="text-align: center;">
                    <button class="timer-btn" onclick="pauseTimer('coding')" id="coding-pause-btn">‚è∏Ô∏è Pause</button>
                    <button class="timer-btn stop" onclick="stopTimer('coding')">‚èπÔ∏è Stop</button>
                </div>
            </div>
            {% endif %}

            {% if coding_topic.detailed_content %}
            <div class="detailed-content">
                <h4>üìñ Detailed Guide:</h4>
                <pre>{{ coding_topic.detailed_content }}</pre>
            </div>
            {% endif %}

            {% if coding_topic.problems %}
            <div class="problems-section">
                <h4>üéØ Practice Problems:</h4>
                {% for problem in coding_topic.problems %}
                <div class="problem-item">
                    <strong><a href="{{ problem.url }}" target="_blank" class="problem-link">
                        #{{ problem.number }} - {{ problem.title }}
                    </a></strong>
                    <span class="difficulty difficulty-{{ problem.difficulty.lower() }}">{{ problem.difficulty }}</span>
                    <p class="problem-desc">{{ problem.description }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if coding_topic_completed %}
            <div class="completed-message">
                <h4>‚úÖ {{ coding_topic.topic }} Complete!</h4>
                <p>Rating: {{ coding_completion_data.rating }}/5 | Notes: {{ coding_completion_data.notes or 'No notes' }}</p>
                <p><em>Great job! Keep up the momentum! üöÄ</em></p>

                <!-- Acceleration UI -->
                <div id="coding-acceleration" class="acceleration-section" style="margin-top: 15px;">
                    <div id="coding-advance-check">
                        <button class="advance-check-btn" onclick="checkAdvancement('coding')"
                                style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            üöÄ Ready for more?
                        </button>
                    </div>
                    <div id="coding-advance-option" style="display: none;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            {% else %}
            <div class="rating">
                <label>Rating (1-5):</label>
                <select id="coding-rating">
                    <option value="1">1 - Very Hard</option>
                    <option value="2">2 - Hard</option>
                    <option value="3" selected>3 - Medium</option>
                    <option value="4">4 - Easy</option>
                    <option value="5">5 - Very Easy</option>
                </select>
            </div>
            <textarea id="coding-notes" class="notes" placeholder="Notes and reflections..."></textarea>
            <button class="complete-btn" id="coding-complete-btn" onclick="markComplete('{{ coding_topic.topic }}', 'coding', 'topic')">
                ‚úÖ Mark Complete
            </button>
            <button class="complete-btn" id="coding-finish-early-btn" style="display: none; background: #28a745;" onclick="finishEarlyAndMarkComplete('coding', '{{ coding_topic.topic }}')" title="Complete this topic before the timer expires. Shows you finished within the estimated time - great for interview skills!">
                ‚è±Ô∏è Finish Early & Mark Complete
            </button>
            {% endif %}
        </div>
        {% endif %}

        {% if system_design_topic %}
        <div class="topic {% if system_design_topic_completed %}completed-section{% endif %}" id="system_design-topic">
            <h3>üèóÔ∏è System Design: {{ system_design_topic.topic }}</h3>
            <p><strong>Activity:</strong> {{ system_design_topic.activity }}</p>

            {% if not system_design_topic_completed %}
            <p class="time-estimate">‚è±Ô∏è {{ system_design_topic.time_estimate }} minutes
                <button class="start-timer-btn" onclick="startPomodoro('system_design', {{ system_design_topic.time_estimate }})" title="Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.">
                    üçÖ Start Timer
                </button>
            </p>

            <div class="pomodoro-section" id="system_design-pomodoro">
                <h4>üçÖ Focus Session</h4>
                <div class="pomodoro-timer" id="system_design-timer">{{ system_design_topic.time_estimate }}:00</div>
                <div style="text-align: center;">
                    <button class="timer-btn" onclick="pauseTimer('system_design')" id="system_design-pause-btn">‚è∏Ô∏è Pause</button>
                    <button class="timer-btn stop" onclick="stopTimer('system_design')">‚èπÔ∏è Stop</button>
                </div>
            </div>
            {% endif %}

            {% if system_design_topic.detailed_content %}
            <div class="detailed-content">
                <h4>üìñ Detailed Guide:</h4>
                <pre>{{ system_design_topic.detailed_content }}</pre>
            </div>
            {% endif %}

            {% if system_design_topic.practice_questions %}
            <div class="practice-section">
                <h4>üéØ Practice Questions:</h4>
                <p><em>Test your understanding by answering these questions after studying the materials:</em></p>

                {% if system_design_topic.practice_questions.estimation %}
                <div class="question-category">
                    <h5>üìä Estimation Questions:</h5>
                    <ul>
                        {% for item in system_design_topic.practice_questions.estimation %}
                        <li class="practice-question-item">
                            {% if item is mapping %}
                            <div class="question-text">{{ item.question }}</div>
                            {% if item.answer %}
                            <button class="toggle-answer-btn" onclick="toggleAnswer(this)">üí° Show Answer</button>
                            <div class="answer-text" style="display: none;">
                                <strong>Answer:</strong> {{ item.answer }}
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="question-text">{{ item }}</div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if system_design_topic.practice_questions.concepts %}
                <div class="question-category">
                    <h5>üí° Concept Questions:</h5>
                    <ul>
                        {% for item in system_design_topic.practice_questions.concepts %}
                        <li class="practice-question-item">
                            {% if item is mapping %}
                            <div class="question-text">{{ item.question }}</div>
                            {% if item.answer %}
                            <button class="toggle-answer-btn" onclick="toggleAnswer(this)">üí° Show Answer</button>
                            <div class="answer-text" style="display: none;">
                                <strong>Answer:</strong> {{ item.answer }}
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="question-text">{{ item }}</div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if system_design_topic.practice_questions.tradeoffs %}
                <div class="question-category">
                    <h5>‚öñÔ∏è Trade-off Questions:</h5>
                    <ul>
                        {% for item in system_design_topic.practice_questions.tradeoffs %}
                        <li class="practice-question-item">
                            {% if item is mapping %}
                            <div class="question-text">{{ item.question }}</div>
                            {% if item.answer %}
                            <button class="toggle-answer-btn" onclick="toggleAnswer(this)">üí° Show Answer</button>
                            <div class="answer-text" style="display: none;">
                                <strong>Answer:</strong> {{ item.answer }}
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="question-text">{{ item }}</div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if system_design_topic.resources %}
            <div class="resources-section">
                <h4>üìö Study Resources:</h4>
                {% for resource in system_design_topic.resources %}
                <div class="resource-item">
                    <strong><a href="{{ resource.url }}" target="_blank" class="resource-link">
                        {{ resource.title }}
                    </a></strong>
                    <p class="resource-desc">{{ resource.description }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if system_design_topic.concepts %}
            <div class="concepts-section">
                <h4>üîë Key Concepts:</h4>
                <ul>
                {% for concept in system_design_topic.concepts %}
                    <li>{{ concept }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if system_design_topic_completed %}
            <div class="completed-message">
                <h4>‚úÖ {{ system_design_topic.topic }} Complete!</h4>
                <p>Rating: {{ system_design_completion_data.rating }}/5 | Notes: {{ system_design_completion_data.notes or 'No notes' }}</p>
                <p><em>Great job! Keep up the momentum! üöÄ</em></p>

                <!-- Acceleration UI -->
                <div id="system_design-acceleration" class="acceleration-section" style="margin-top: 15px;">
                    <div id="system_design-advance-check">
                        <button class="advance-check-btn" onclick="checkAdvancement('system_design')"
                                style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            üöÄ Ready for more?
                        </button>
                    </div>
                    <div id="system_design-advance-option" style="display: none;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            {% else %}
            <div class="rating">
                <label>Rating (1-5):</label>
                <select id="system_design-rating">
                    <option value="1">1 - Very Hard</option>
                    <option value="2">2 - Hard</option>
                    <option value="3" selected>3 - Medium</option>
                    <option value="4">4 - Easy</option>
                    <option value="5">5 - Very Easy</option>
                </select>
            </div>
            <textarea id="system_design-notes" class="notes" placeholder="Notes and reflections..."></textarea>
            <button class="complete-btn" id="system_design-complete-btn" onclick="markComplete('{{ system_design_topic.topic }}', 'system_design', 'topic')">
                ‚úÖ Mark Complete
            </button>
            <button class="complete-btn" id="system_design-finish-early-btn" style="display: none; background: #28a745;" onclick="console.log('Button clicked!'); finishEarlyAndMarkComplete('system_design', '{{ system_design_topic.topic }}')" title="Complete this topic before the timer expires. Shows you finished within the estimated time - great for interview skills!">
                ‚è±Ô∏è Finish Early & Mark Complete
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if due_reviews %}
    <div class="section">
        <h2>üîÑ Due Reviews</h2>
        {% for review in due_reviews %}
        <div class="review" id="review-{{ loop.index }}">
            <h4>{{ review.track.replace('_', ' ') | title }}: {{ review.topic }} ({{ review.review_type }} review)</h4>
            <p>Originally completed: {{ review.scheduled_date }}</p>

            {% if review.problems or review.practice_questions %}
            <div class="review-practice-section" id="practice-section-{{ loop.index }}">
                {% if review.track == 'coding' %}
                <h5>üéØ Practice Problems</h5>
                {% else %}
                <h5>üéØ Practice Questions</h5>
                {% endif %}

                {% if review.benchmarks %}
                <div class="time-benchmarks" style="margin: 10px 0; font-size: 14px; color: #666;">
                    <strong>Time Benchmarks:</strong>
                    Base time: {{ "%.0f"|format(review.benchmarks.total_base_minutes) }} min |
                    Rating 5: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[5].max_minutes) }} min |
                    Rating 4: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[4].max_minutes) }} min |
                    Rating 3: ‚â§{{ "%.0f"|format(review.benchmarks.rating_benchmarks[3].max_minutes) }} min
                </div>
                {% endif %}

                <div class="practice-controls" style="margin: 10px 0;">
                    {% if review.track == 'coding' %}
                    <button class="practice-btn" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px;"
                            onclick="startReviewPractice({{ loop.index }}, '{{ review.topic }}', '{{ review.track }}')">
                        üèÉ Start Review Practice
                    </button>
                    {% else %}
                    <button class="practice-btn" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px;"
                            onclick="startSystemDesignPractice({{ loop.index }}, '{{ review.topic }}', '{{ review.track }}', '{{ review.review_type }}')">
                        üèÉ Start System Design Practice
                    </button>
                    {% endif %}
                    <span class="practice-timer" id="practice-timer-{{ loop.index }}" style="font-weight: bold; display: none;">‚è±Ô∏è 00:00</span>
                    <button class="practice-btn" id="pause-practice-{{ loop.index }}" style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 5px; display: none;"
                            onclick="togglePauseReviewPractice({{ loop.index }})">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="practice-btn" id="stop-practice-{{ loop.index }}" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; display: none;"
                            onclick="stopReviewPractice({{ loop.index }})">
                        ‚èπÔ∏è Stop Practice
                    </button>
                </div>

                {% if review.track == 'coding' %}
                {% set review_index = loop.index %}
                <div class="problems-list" id="problems-list-{{ review_index }}">
                    {% for problem in review.problems %}
                    <div class="problem-item" style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <a href="{{ problem.url }}" target="_blank" class="problem-link" style="color: #007bff; text-decoration: none;">
                                #{{ problem.number }} - {{ problem.title }}
                            </a>
                            <span class="difficulty difficulty-{{ problem.difficulty.lower() }}" style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                {{ problem.difficulty }}
                            </span>
                        </div>
                        <p style="margin: 4px 0; color: #666; font-size: 14px;">{{ problem.description }}</p>
                        <div class="problem-timer-section" id="problem-timer-{{ review_index }}-{{ loop.index0 }}" style="display: none; margin-top: 8px;">
                            <button class="complete-problem-btn" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px;"
                                    onclick="markProblemComplete({{ review_index }}, {{ loop.index0 }})">
                                ‚úÖ Mark Problem Complete
                            </button>
                            <span class="problem-time" style="margin-left: 10px; font-size: 12px; color: #666;">Time: <span id="problem-time-{{ review_index }}-{{ loop.index0 }}">0 min</span></span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                {% set review_index = loop.index %}
                <div class="questions-list" id="questions-list-{{ review_index }}">
                    {% for question in review.practice_questions %}
                    <div class="question-item" style="margin: 12px 0; padding: 12px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <div class="question-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span class="question-type" style="background: #{{ 'e3f2fd' if question.type == 'estimation' else 'fff3e0' if question.type == 'concepts' else 'f3e5f5' if question.type == 'tradeoffs' else 'e8f5e8' }}; color: #{{ '1976d2' if question.type == 'estimation' else 'f57c00' if question.type == 'concepts' else '7b1fa2' if question.type == 'tradeoffs' else '388e3c' }}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                                {{ question.type }}
                            </span>
                            <span class="question-number" style="color: #666; font-size: 12px;">Q{{ loop.index0 + 1 }}</span>
                        </div>
                        <div class="question-text" style="margin: 8px 0; font-weight: 500; color: #333;">
                            {{ question.question }}
                        </div>
                        <div class="answer-section" id="answer-section-{{ review_index }}-{{ loop.index0 }}" style="display: none; margin-top: 12px;">
                            <textarea id="answer-{{ review_index }}-{{ loop.index0 }}"
                                    style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
                                    placeholder="Enter your answer here..."></textarea>
                            <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <button class="mark-answered-btn" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; font-size: 12px;"
                                        onclick="markQuestionAnswered({{ review_index }}, {{ loop.index0 }})">
                                    ‚úÖ Mark Answered
                                </button>
                                <span class="answer-time" style="font-size: 12px; color: #666;">Time: <span id="answer-time-{{ review_index }}-{{ loop.index0 }}">0 min</span></span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="practice-summary" id="practice-summary-{{ loop.index }}" style="display: none; margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <h6>üéØ Practice Summary</h6>
                    <p>Total Time: <span id="total-practice-time-{{ loop.index }}">0</span> minutes</p>
                    <p>Suggested Rating: <strong id="suggested-rating-{{ loop.index }}">-</strong></p>
                    <div style="margin: 8px 0;">
                        <label style="font-size: 14px;">Adjust your rating if needed:</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="rating">
                <label>How well do you remember? (1-5):</label>
                <select id="review-rating-{{ loop.index }}">
                    <option value="1">1 - Completely forgot</option>
                    <option value="2">2 - Vague memory</option>
                    <option value="3" selected>3 - Some memory</option>
                    <option value="4">4 - Good memory</option>
                    <option value="5">5 - Perfect recall</option>
                </select>
                <span id="rating-suggestion-{{ loop.index }}" style="margin-left: 10px; color: #007bff; font-weight: bold; display: none;"></span>
            </div>
            <textarea id="review-notes-{{ loop.index }}" class="notes" placeholder="Review notes..."></textarea>
            <button class="complete-btn" onclick="markCompleteWithPracticeData('{{ review.topic }}', '{{ review.track }}', 'review', {{ loop.index }})">
                ‚úÖ Review Complete
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <script>
        // Define startPomodoro at the very top to ensure global availability
        let serverUnavailable = false;

        async function startPomodoro(track, minutes) {
            console.log(`Starting Pomodoro for track: ${track}, minutes: ${minutes}`);
            console.log(`serverUnavailable flag: ${serverUnavailable}`);

            // Check if server is available
            if (serverUnavailable) {
                console.log('Server unavailable, blocking timer start');
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            console.log('Server available, proceeding with timer start...');
            try {
                // First check if there's already an active timer
                console.log('Checking current timer state...');
                const stateResponse = await fetch('/api/timer/state');
                console.log('State response received:', stateResponse.status);
                if (stateResponse.ok) {
                    const currentState = await stateResponse.json();
                    console.log('Current timer state:', currentState);

                    // If there's an active timer for a different track/topic, ask for confirmation
                    if (currentState.active && currentState.track !== track) {
                        const remainingMins = Math.floor(currentState.remaining / 60);
                        const remainingSecs = Math.floor(currentState.remaining % 60);
                        const timeLeft = `${remainingMins}:${remainingSecs.toString().padStart(2, '0')}`;

                        const currentTopicName = currentState.topic || 'Unknown Topic';
                        const newTopicName = getTopicName(track);

                        const confirmed = confirm(
                            `‚ö†Ô∏è You already have an active timer running!\n\n` +
                            `Current: ${currentState.track.replace('_', ' ')} - "${currentTopicName}"\n` +
                            `Time remaining: ${timeLeft}\n\n` +
                            `Do you want to stop it and start a new timer for:\n` +
                            `"${newTopicName}" (${minutes} minutes)?\n\n` +
                            `Click OK to replace, Cancel to keep current timer.`
                        );

                        if (!confirmed) {
                            // User chose to keep current timer, scroll to it
                            scrollToActiveTimer(currentState.track);
                            return;
                        }
                    }
                }

                console.log('Starting timer API call...');
                const topicName = getTopicName(track);
                console.log('Topic name:', topicName);
                console.log('Request body:', {track, topic: topicName, duration: minutes});

                const response = await fetch('/api/timer/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        track: track,
                        topic: topicName,
                        duration: minutes
                    })
                });

                console.log('Timer start response:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Timer started successfully:', result);
                    // Timer started successfully, sync will update display
                    await syncTimerState();

                    // Scroll to timer
                    const pomodoroSection = document.getElementById(`${track}-pomodoro`);
                    if (pomodoroSection) {
                        pomodoroSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    alert('Error starting timer. Please try again.');
                }
            } catch (error) {
                console.error('Error starting timer:', error);
                alert('Network error starting timer. Please try again.');
            }
        }

        // Make globally available immediately
        window.startPomodoro = startPomodoro;

        async function markComplete(topic, track, type, reviewIndex = null) {
            // For reviews, delegate to the enhanced function
            if (type === 'review') {
                return markCompleteWithPracticeData(topic, track, type, reviewIndex);
            }

            console.log(`markComplete called with topic: ${topic}, track: ${track}, type: ${type}`);
            let rating, notes;

            let elementId;
            if (type === 'topic') {
                elementId = `${track}-topic`;
                const ratingSelect = document.getElementById(`${track}-rating`);
                const notesTextarea = document.getElementById(`${track}-notes`);

                console.log(`Looking for elements: ${track}-rating, ${track}-notes`);
                console.log(`Rating element found: ${ratingSelect ? 'YES' : 'NO'}`);
                console.log(`Notes element found: ${notesTextarea ? 'YES' : 'NO'}`);

                if (!ratingSelect || !notesTextarea) {
                    console.error(`Missing form elements for ${track}`);
                    return;
                }

                rating = parseInt(ratingSelect.value);
                notes = notesTextarea.value;
                console.log(`Rating: ${rating}, Notes: ${notes}`);
            }

            // Disable the section immediately to prevent double-submission
            const element = document.getElementById(elementId);
            console.log(`Looking for element: ${elementId}`);
            console.log(`Element found: ${element ? 'YES' : 'NO'}`);

            if (!element) {
                console.error(`Could not find element with ID: ${elementId}`);
                return;
            }

            element.style.pointerEvents = 'none';
            const button = element.querySelector('.complete-btn');
            console.log(`Button found: ${button ? 'YES' : 'NO'}`);

            if (!button) {
                console.error(`Could not find .complete-btn within element ${elementId}`);
                return;
            }

            button.textContent = '‚è≥ Saving...';
            button.style.background = '#6c757d';

            try {
                const response = await fetch('/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        track: track,
                        type: type,
                        rating: rating,
                        notes: notes,
                        completed_on_time: await getCompletionTimingStatus(track)
                    })
                });

                if (response.ok) {
                    // Replace the form with a completion message
                    const completionMessage = document.createElement('div');
                    completionMessage.className = 'completed-message';
                    completionMessage.innerHTML = `
                        <h4>‚úÖ ${topic} Complete!</h4>
                        <p>Rating: ${rating}/5 | Notes: ${notes || 'No notes'}</p>
                        <p><em>Great job! Keep up the momentum! üöÄ</em></p>
                    `;

                    // Hide input elements and show completion message
                    const ratingDiv = element.querySelector('.rating');
                    const notesTextarea = element.querySelector('.notes');
                    const button = element.querySelector('.complete-btn');

                    if (ratingDiv) ratingDiv.style.display = 'none';
                    if (notesTextarea) notesTextarea.style.display = 'none';
                    if (button) button.style.display = 'none';

                    element.appendChild(completionMessage);
                    element.classList.add('completed-section');
                } else {
                    // Re-enable on error
                    element.style.pointerEvents = 'auto';
                    button.textContent = '‚úÖ Mark Complete';
                    button.style.background = '#28a745';
                    alert('‚ùå Error saving completion. Please try again.');
                }
            } catch (error) {
                // Re-enable on error
                const element = document.getElementById(elementId);
                element.style.pointerEvents = 'auto';
                const button = element.querySelector('.complete-btn');
                button.textContent = '‚úÖ Mark Complete';
                button.style.background = '#28a745';
                alert('‚ùå Network error. Please check your connection and try again.');
                console.error(error);
            }
        }

        // Server-synced Pomodoro Timer functionality
        let updateInterval = null;
        let currentTrack = null;

        // Initialize timer state sync when page loads
        let syncInterval = null;

        // Timer state variables and functions defined at top

        // Theme Toggle Functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            updateHighlightTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            updateHighlightTheme(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                themeToggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            }
        }

        function updateHighlightTheme(theme) {
            const lightHighlight = document.getElementById('highlight-light');
            const darkHighlight = document.getElementById('highlight-dark');

            if (theme === 'dark') {
                if (lightHighlight) lightHighlight.disabled = true;
                if (darkHighlight) darkHighlight.disabled = false;
            } else {
                if (lightHighlight) lightHighlight.disabled = false;
                if (darkHighlight) darkHighlight.disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing timer system...');

            // Initialize theme first
            initTheme();

            // Add theme toggle event listener
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Initialize syntax highlighting for code blocks
            hljs.highlightAll();

            // Initialize timer state and sync
            syncTimerState();
            // Start with 2-second intervals
            startTimerSync();
            // Clean up old practice sessions from localStorage
            cleanupOldPracticeSessions();
        });

        function cleanupOldPracticeSessions() {
            const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            const now = Date.now();

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('practice_session_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.timestamp && (now - data.timestamp) > MAX_AGE) {
                            localStorage.removeItem(key);
                            console.log('Cleaned up old practice session:', key);
                        }
                    } catch (e) {
                        // Invalid data, remove it
                        localStorage.removeItem(key);
                        console.log('Removed invalid practice session data:', key);
                    }
                }
            }
        }

        function startTimerSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncTimerState, 2000);
        }

        function stopTimerSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        async function syncTimerState() {
            try {
                const response = await fetch('/api/timer/state');
                if (response.ok) {
                    const state = await response.json();
                    updateTimerDisplay(state);

                    // Server is back online
                    if (serverUnavailable) {
                        console.log('Timer sync: Server connection restored');
                        serverUnavailable = false;
                    }
                } else {
                    // Server responded but with an error
                    console.warn('Timer state API returned error:', response.status);
                }
            } catch (error) {
                // Network error - server might not be running
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    if (!serverUnavailable) {
                        console.warn('Timer sync: Server not reachable, timer features disabled');
                        serverUnavailable = true;
                        // Disable timer functionality gracefully
                        hideAllTimers();
                    }
                } else {
                    console.error('Error syncing timer state:', error);
                }
            }
        }

        function updateTimerDisplay(state) {
            const allTracks = ['coding', 'system_design'];

            if (!state.active) {
                // No active timer - hide all timer sections and reset button states
                hideAllTimers();
                updateStartButtonStates(null);
                return;
            }

            // Show timer for the active track
            const track = state.track;
            const pomodoroSection = document.getElementById(`${track}-pomodoro`);
            const startButton = document.querySelector(`#${track}-topic .start-timer-btn`);
            const timerDisplay = document.getElementById(`${track}-timer`);
            const pauseButton = document.getElementById(`${track}-pause-btn`);
            const completeBtn = document.getElementById(`${track}-complete-btn`);
            const finishEarlyBtn = document.getElementById(`${track}-finish-early-btn`);

            if (!pomodoroSection || !timerDisplay) return;

            // Show timer section and hide start button
            pomodoroSection.style.display = 'block';
            if (startButton) startButton.style.display = 'none';

            // Update timer display
            if (state.remaining > 0) {
                const totalSeconds = Math.floor(state.remaining);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerDisplay.textContent = timeText;
                timerDisplay.style.color = '';

                // Update button states
                if (pauseButton) {
                    if (state.paused) {
                        pauseButton.innerHTML = '‚ñ∂Ô∏è Resume';
                        pauseButton.className = 'timer-btn';
                    } else {
                        pauseButton.innerHTML = '‚è∏Ô∏è Pause';
                        pauseButton.className = 'timer-btn pause';
                    }
                }

                // Show finish early button, hide complete button
                if (completeBtn) completeBtn.style.display = 'none';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'inline-block';
            } else {
                // Timer expired
                timerDisplay.textContent = "00:00";
                timerDisplay.style.color = '#28a745';

                // Show complete button, hide finish early button
                if (completeBtn) completeBtn.style.display = 'inline-block';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'none';

                // Show completion notification once
                if (currentTrack !== track) {
                    alert(`üéâ Pomodoro complete! Great focus session on ${track.replace('_', ' ')}!`);
                    currentTrack = track;
                }
            }

            // Hide timers for other tracks and update their start button states
            for (const otherTrack of allTracks) {
                if (otherTrack !== track) {
                    const otherPomodoroSection = document.getElementById(`${otherTrack}-pomodoro`);
                    const otherStartButton = document.querySelector(`#${otherTrack}-topic .start-timer-btn`);
                    if (otherPomodoroSection) otherPomodoroSection.style.display = 'none';
                    if (otherStartButton) otherStartButton.style.display = 'inline-block';
                }
            }

            // Update start button states to show which has active timer
            updateStartButtonStates(state);
        }

        function updateStartButtonStates(activeState) {
            const allTracks = ['coding', 'system_design'];

            for (const track of allTracks) {
                const startButton = document.querySelector(`#${track}-topic .start-timer-btn:not([title*="Template"])`);
                if (!startButton) continue;

                if (!activeState || !activeState.active) {
                    // No active timer - reset to normal state
                    startButton.innerHTML = 'üçÖ Start Timer';
                    startButton.style.backgroundColor = '#17a2b8';
                    startButton.title = `Start a focused Pomodoro timer for this topic. Tracks whether you finish within the estimated time for interview preparation.`;
                } else if (activeState.track === track) {
                    // This track has the active timer - button should be hidden by timer display
                    startButton.style.display = 'none';
                } else {
                    // Another track has active timer - show warning state
                    const activeTrackName = activeState.track.replace('_', ' ');
                    const remainingMins = Math.floor(activeState.remaining / 60);
                    const remainingSecs = Math.floor(activeState.remaining % 60);
                    const timeLeft = `${remainingMins}:${remainingSecs.toString().padStart(2, '0')}`;

                    startButton.innerHTML = `‚ö†Ô∏è Timer Active (${timeLeft})`;
                    startButton.style.backgroundColor = '#ffc107';
                    startButton.style.color = '#212529';
                    startButton.title = `Another timer is active: ${activeTrackName} - "${activeState.topic}" (${timeLeft} remaining). Click to switch timers.`;
                }
            }
        }

        function hideAllTimers() {
            const allTracks = ['coding', 'system_design'];
            for (const track of allTracks) {
                const pomodoroSection = document.getElementById(`${track}-pomodoro`);
                const startButton = document.querySelector(`#${track}-topic .start-timer-btn`);
                const completeBtn = document.getElementById(`${track}-complete-btn`);
                const finishEarlyBtn = document.getElementById(`${track}-finish-early-btn`);

                if (pomodoroSection) pomodoroSection.style.display = 'none';
                if (startButton) {
                    startButton.style.display = 'inline-block';
                    // Reset button appearance
                    startButton.innerHTML = 'üçÖ Start Timer';
                    startButton.style.backgroundColor = '#17a2b8';
                    startButton.style.color = 'white';
                }
                if (completeBtn) completeBtn.style.display = 'inline-block';
                if (finishEarlyBtn) finishEarlyBtn.style.display = 'none';
            }
            currentTrack = null;
        }

        function scrollToActiveTimer(track) {
            const pomodoroSection = document.getElementById(`${track}-pomodoro`);
            if (pomodoroSection && pomodoroSection.style.display !== 'none') {
                pomodoroSection.scrollIntoView({ behavior: 'smooth' });
                // Add a brief highlight effect
                pomodoroSection.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    pomodoroSection.style.backgroundColor = '';
                }, 2000);
            }
        }

        async function pauseTimer(track) {
            // Check if server is available
            if (serverUnavailable) {
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            try {
                // First get current timer state to determine if we should pause or resume
                const stateResponse = await fetch('/api/timer/state');
                if (!stateResponse.ok) {
                    alert('Error getting timer state. Please try again.');
                    return;
                }

                const currentState = await stateResponse.json();

                // Determine which endpoint to call based on current state
                const endpoint = currentState.paused ? '/api/timer/resume' : '/api/timer/pause';
                const action = currentState.paused ? 'resuming' : 'pausing';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Timer action successful, sync will update display
                    await syncTimerState();
                } else {
                    alert(`Error ${action} timer. Please try again.`);
                }
            } catch (error) {
                console.error('Error with timer:', error);
                alert('Network error with timer. Please try again.');
            }
        }

        async function stopTimer(track) {
            // Check if server is available
            if (serverUnavailable) {
                alert('Timer feature unavailable: Server connection lost. Please refresh the page.');
                return;
            }

            try {
                const response = await fetch('/api/timer/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Timer stopped successfully, sync will update display
                    await syncTimerState();
                } else {
                    alert('Error stopping timer. Please try again.');
                }
            } catch (error) {
                console.error('Error stopping timer:', error);
                alert('Network error stopping timer. Please try again.');
            }
        }

        function getTopicName(track) {
            // Extract topic name from the page
            const topicElement = document.querySelector(`#${track}-topic h3`);
            if (topicElement) {
                const text = topicElement.textContent;
                // Extract topic name after the prefix (e.g., "üíª Coding: Topic Name")
                const colonIndex = text.indexOf(':');
                if (colonIndex !== -1) {
                    return text.substring(colonIndex + 1).trim();
                }
            }
            return 'Unknown Topic';
        }

        // Helper function to determine completion timing status
        async function getCompletionTimingStatus(track) {
            try {
                const response = await fetch('/api/timer/state');
                if (response.ok) {
                    const state = await response.json();
                    if (!state.active || state.track !== track) {
                        return null; // No timer for this track
                    }
                    if (state.remaining <= 0) {
                        return false; // Timer expired - completed over time
                    }
                    return true; // Timer still running - completed early
                }
            } catch (error) {
                console.error('Error checking timer status:', error);
            }
            return null;
        }

        // Function for finishing early with timer
        async function finishEarlyAndMarkComplete(track, topic) {
            console.log(`finishEarlyAndMarkComplete called with track: ${track}, topic: ${topic}`);

            try {
                // Stop the timer first
                await stopTimer(track);

                // Call the regular markComplete function which will handle timing status
                await markComplete(topic, track, 'topic');
                console.log(`markComplete completed successfully for ${track}`);
            } catch (error) {
                console.error(`Error in finishEarlyAndMarkComplete for ${track}:`, error);
            }
        }

        // Review Practice Timer System
        let reviewPracticeTimers = {}; // Track active practice sessions
        let systemDesignSessions = {}; // Track system design practice sessions
        let problemStartTimes = {}; // Track individual problem start times
        let completedProblems = {}; // Track completed problems per review

        function startReviewPractice(reviewIndex, topic, track) {
            console.log(`Starting review practice for ${topic} (${track})`);

            // Initialize tracking for this review
            if (!reviewPracticeTimers[reviewIndex]) {
                reviewPracticeTimers[reviewIndex] = {
                    startTime: Date.now(),
                    interval: null,
                    topic: topic,
                    track: track,
                    totalMinutes: 0,
                    paused: false,
                    pausedTime: 0,
                    pauseStartTime: null
                };
                completedProblems[reviewIndex] = [];
            }

            // Show practice controls
            document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'inline';
            document.getElementById(`pause-practice-${reviewIndex}`).style.display = 'inline';
            document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'inline';

            // Show individual problem timers
            const problemTimers = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-timer-section`);
            problemTimers.forEach((timer, problemIndex) => {
                timer.style.display = 'block';
                // Start timing each problem immediately
                const problemKey = `${reviewIndex}-${problemIndex}`;
                problemStartTimes[problemKey] = Date.now();
            });

            // Start the main timer
            reviewPracticeTimers[reviewIndex].interval = setInterval(() => {
                updateReviewPracticeTimer(reviewIndex);
                updateIndividualProblemTimers(reviewIndex);
            }, 1000);

            // Disable the start button
            const startButton = document.querySelector(`button[onclick*="startReviewPractice(${reviewIndex}"]`);
            if (startButton) {
                startButton.disabled = true;
                startButton.textContent = 'üèÉ Practice In Progress...';
            }
        }

        function updateReviewPracticeTimer(reviewIndex) {
            const timer = reviewPracticeTimers[reviewIndex];
            if (!timer) return;

            // Don't update if paused
            if (timer.paused) return;

            const elapsed = Date.now() - timer.startTime - timer.pausedTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById(`practice-timer-${reviewIndex}`).textContent =
                `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timer.totalMinutes = minutes + (seconds / 60);
        }

        function togglePauseReviewPractice(reviewIndex) {
            const timer = reviewPracticeTimers[reviewIndex];
            const session = systemDesignSessions[reviewIndex];

            // Handle coding reviews
            if (timer) {
                if (timer.paused) {
                    // Resume
                    timer.paused = false;
                    timer.pausedTime += Date.now() - timer.pauseStartTime;
                    timer.pauseStartTime = null;

                    // Update button
                    const pauseButton = document.getElementById(`pause-practice-${reviewIndex}`);
                    pauseButton.innerHTML = '‚è∏Ô∏è Pause';
                    pauseButton.style.background = '#ffc107';
                } else {
                    // Pause
                    timer.paused = true;
                    timer.pauseStartTime = Date.now();

                    // Update button
                    const pauseButton = document.getElementById(`pause-practice-${reviewIndex}`);
                    pauseButton.innerHTML = '‚ñ∂Ô∏è Resume';
                    pauseButton.style.background = '#28a745';
                }
            }

            // Handle system design sessions
            if (session) {
                if (session.paused) {
                    // Resume
                    session.paused = false;
                    session.pausedTime += Date.now() - session.pauseStartTime;
                    session.pauseStartTime = null;

                    // Update button
                    const pauseButton = document.getElementById(`pause-practice-${reviewIndex}`);
                    pauseButton.innerHTML = '‚è∏Ô∏è Pause';
                    pauseButton.style.background = '#ffc107';
                } else {
                    // Pause
                    session.paused = true;
                    session.pauseStartTime = Date.now();

                    // Update button
                    const pauseButton = document.getElementById(`pause-practice-${reviewIndex}`);
                    pauseButton.innerHTML = '‚ñ∂Ô∏è Resume';
                    pauseButton.style.background = '#28a745';
                }
            }
        }

        function updateIndividualProblemTimers(reviewIndex) {
            const session = reviewPracticeTimers[reviewIndex];
            // Don't update if paused
            if (session && session.paused) return;

            const problemTimers = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-timer-section`);
            problemTimers.forEach((timer, problemIndex) => {
                const problemKey = `${reviewIndex}-${problemIndex}`;
                const startTime = problemStartTimes[problemKey];
                if (!startTime) return;

                // Only update if problem not yet completed
                const completeButton = timer.querySelector('.complete-problem-btn');
                if (completeButton && !completeButton.disabled) {
                    const pausedTime = session ? session.pausedTime : 0;
                    const elapsed = Date.now() - startTime - pausedTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);

                    const timeDisplay = document.getElementById(`problem-time-${reviewIndex}-${problemIndex}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            });
        }

        function markProblemComplete(reviewIndex, problemIndex) {
            console.log(`Marking problem ${problemIndex} complete for review ${reviewIndex}`);

            const problemKey = `${reviewIndex}-${problemIndex}`;
            const session = reviewPracticeTimers[reviewIndex];

            // Use existing start time (should already be set when practice started)
            const startTime = problemStartTimes[problemKey];
            if (!startTime) {
                console.warn(`No start time found for problem ${problemKey}, using current time`);
                problemStartTimes[problemKey] = Date.now();
            }

            const pausedTime = session ? session.pausedTime : 0;
            const elapsed = Date.now() - problemStartTimes[problemKey] - pausedTime;
            const minutes = Math.round(elapsed / 60000);

            // Update the problem time display to final time
            document.getElementById(`problem-time-${reviewIndex}-${problemIndex}`).textContent = `${minutes} min`;

            // Mark as completed
            if (!completedProblems[reviewIndex]) {
                completedProblems[reviewIndex] = [];
            }
            completedProblems[reviewIndex].push({
                problemIndex: problemIndex,
                timeMinutes: minutes
            });

            // Disable the button
            const completeButton = document.querySelector(`#problem-timer-${reviewIndex}-${problemIndex} .complete-problem-btn`);
            if (completeButton) {
                completeButton.disabled = true;
                completeButton.textContent = '‚úÖ Completed';
                completeButton.style.background = '#6c757d';
            }

            console.log(`Problem completed in ${minutes} minutes`);
        }

        function stopReviewPractice(reviewIndex) {
            console.log(`stopReviewPractice called for review ${reviewIndex}`);

            const timer = reviewPracticeTimers[reviewIndex];
            const session = systemDesignSessions[reviewIndex];

            if (timer) {
                console.log('Stopping coding review practice');
                stopCodingReviewPractice(reviewIndex, timer);
            } else if (session) {
                console.log('Stopping system design practice');
                stopSystemDesignPractice(reviewIndex);
            } else {
                console.error(`No active session found for review ${reviewIndex}`);
                alert('No active practice session found. The session may have already been stopped.');
            }
        }

        function stopCodingReviewPractice(reviewIndex, timer) {
            try {
                // Stop the timer
                clearInterval(timer.interval);

                // Calculate final results
                const totalMinutes = Math.round(timer.totalMinutes);
                console.log(`Total practice time: ${totalMinutes} minutes`);

                // Simple rating calculation based on completion
                const problemCount = completedProblems[reviewIndex] ? completedProblems[reviewIndex].length : 0;
                const totalProblems = document.querySelectorAll(`#practice-section-${reviewIndex} .problem-item`).length;
                console.log(`Completed ${problemCount} of ${totalProblems} problems`);

                let suggestedRating = 3; // Default
                if (problemCount === totalProblems) {
                    // All problems completed - base rating on time
                    if (totalMinutes <= 30) suggestedRating = 5;
                    else if (totalMinutes <= 45) suggestedRating = 4;
                    else if (totalMinutes <= 70) suggestedRating = 3;
                    else if (totalMinutes <= 100) suggestedRating = 2;
                    else suggestedRating = 1;
                } else {
                    // Not all problems completed
                    const completionRate = problemCount / totalProblems;
                    if (completionRate >= 0.8) suggestedRating = 3;
                    else if (completionRate >= 0.5) suggestedRating = 2;
                    else suggestedRating = 1;
                }

                // Show practice summary
                const summaryElement = document.getElementById(`practice-summary-${reviewIndex}`);
                if (summaryElement) {
                    summaryElement.style.display = 'block';

                    const timeElement = document.getElementById(`total-practice-time-${reviewIndex}`);
                    if (timeElement) timeElement.textContent = totalMinutes;

                    const ratingElement = document.getElementById(`suggested-rating-${reviewIndex}`);
                    if (ratingElement) ratingElement.textContent = `${suggestedRating} (${getRatingDescription(suggestedRating)})`;
                }

                // Update the rating dropdown and show suggestion
                const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
                if (ratingSelect) {
                    ratingSelect.value = suggestedRating;
                }

                const suggestionSpan = document.getElementById(`rating-suggestion-${reviewIndex}`);
                if (suggestionSpan) {
                    suggestionSpan.textContent = `(Suggested: ${suggestedRating})`;
                    suggestionSpan.style.display = 'inline';
                }

                // Hide practice controls
                const timerElement = document.getElementById(`practice-timer-${reviewIndex}`);
                const pauseElement = document.getElementById(`pause-practice-${reviewIndex}`);
                const stopElement = document.getElementById(`stop-practice-${reviewIndex}`);

                if (timerElement) timerElement.style.display = 'none';
                if (pauseElement) {
                    pauseElement.style.display = 'none';
                    pauseElement.innerHTML = '‚è∏Ô∏è Pause';
                    pauseElement.style.background = '#ffc107';
                }
                if (stopElement) stopElement.style.display = 'none';

                // Re-enable start button
                const startButton = document.querySelector(`button[onclick*="startReviewPractice(${reviewIndex}"]`);
                if (startButton) {
                    startButton.disabled = false;
                    startButton.textContent = 'üèÉ Start Review Practice';
                }

                console.log(`Review practice stopped: ${totalMinutes} minutes, suggested rating: ${suggestedRating}`);
            } catch (error) {
                console.error('Error stopping coding review practice:', error);
                alert('Error stopping practice session. Please refresh the page.');
            }
        }

        function getRatingDescription(rating) {
            const descriptions = {
                5: 'Perfect recall',
                4: 'Good memory',
                3: 'Some memory',
                2: 'Vague memory',
                1: 'Completely forgot'
            };
            return descriptions[rating] || 'Unknown';
        }

        // System Design Practice Functions
        async function startSystemDesignPractice(reviewIndex, topic, track, reviewType) {
            console.log(`Starting system design practice for ${topic} (${reviewType})`);

            try {
                // Create session key for this practice session
                const sessionKey = `${track}_${topic}_${reviewType}`.replace(/\s+/g, '_');

                // Check if we have cached questions for this session
                const cachedData = localStorage.getItem(`practice_session_${sessionKey}`);
                let requestBody = {
                    topic: topic,
                    track: track,
                    review_type: reviewType,
                    use_cached: false
                };

                if (cachedData) {
                    const parsedData = JSON.parse(cachedData);
                    requestBody.use_cached = true;
                    requestBody.cached_questions = parsedData.questions;
                    console.log('Using cached questions for', sessionKey);
                }

                // Fetch practice questions and benchmarks
                const response = await fetch('/api/system-design-practice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to load practice questions');
                }

                const data = await response.json();

                // Save questions to localStorage if they're newly generated
                if (!cachedData) {
                    const sessionData = {
                        questions: data.questions,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(`practice_session_${sessionKey}`, JSON.stringify(sessionData));
                    console.log('Saved new questions to localStorage for', sessionKey);
                }

                // Initialize session tracking
                systemDesignSessions[reviewIndex] = {
                    startTime: Date.now(),
                    interval: null,
                    topic: topic,
                    track: track,
                    reviewType: reviewType,
                    questions: data.questions,
                    benchmarks: data.benchmarks,
                    answers: {},
                    questionStartTimes: {},
                    totalMinutes: 0,
                    sessionKey: sessionKey,
                    paused: false,
                    pausedTime: 0,
                    pauseStartTime: null
                };

                // Show practice controls
                document.getElementById(`practice-timer-${reviewIndex}`).style.display = 'inline';
                document.getElementById(`pause-practice-${reviewIndex}`).style.display = 'inline';
                document.getElementById(`stop-practice-${reviewIndex}`).style.display = 'inline';

                // Show answer sections for all questions and start timing each one
                const answerSections = document.querySelectorAll(`#practice-section-${reviewIndex} .answer-section`);
                answerSections.forEach((section, questionIndex) => {
                    section.style.display = 'block';
                    // Start timing each question immediately
                    const questionKey = `${reviewIndex}-${questionIndex}`;
                    systemDesignSessions[reviewIndex].questionStartTimes[questionKey] = Date.now();
                });

                // Start the main timer
                systemDesignSessions[reviewIndex].interval = setInterval(() => {
                    updateSystemDesignTimer(reviewIndex);
                    updateIndividualQuestionTimers(reviewIndex);
                }, 1000);

                // Disable the start button
                const startButton = document.querySelector(`button[onclick*="startSystemDesignPractice(${reviewIndex}"]`);
                if (startButton) {
                    startButton.disabled = true;
                    startButton.textContent = 'üèÉ Practice In Progress...';
                }

                console.log(`System design practice started with ${data.questions.length} questions`);

            } catch (error) {
                console.error('Error starting system design practice:', error);
                alert('Failed to start practice session. Please try again.');
            }
        }

        function updateSystemDesignTimer(reviewIndex) {
            const session = systemDesignSessions[reviewIndex];
            if (!session) return;

            // Don't update if paused
            if (session.paused) return;

            const elapsed = Date.now() - session.startTime - session.pausedTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById(`practice-timer-${reviewIndex}`).textContent =
                `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            session.totalMinutes = minutes + (seconds / 60);
        }

        function updateIndividualQuestionTimers(reviewIndex) {
            const session = systemDesignSessions[reviewIndex];
            if (!session) return;

            // Don't update if paused
            if (session.paused) return;

            const answerSections = document.querySelectorAll(`#practice-section-${reviewIndex} .answer-section`);
            answerSections.forEach((section, questionIndex) => {
                const questionKey = `${reviewIndex}-${questionIndex}`;
                const startTime = session.questionStartTimes[questionKey];
                if (!startTime) return;

                // Only update if question not yet answered
                const answerButton = section.querySelector('.mark-answered-btn');
                if (answerButton && !answerButton.disabled) {
                    const elapsed = Date.now() - startTime - session.pausedTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);

                    const timeDisplay = document.getElementById(`answer-time-${reviewIndex}-${questionIndex}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            });
        }

        function markQuestionAnswered(reviewIndex, questionIndex) {
            console.log(`markQuestionAnswered called with reviewIndex: ${reviewIndex}, questionIndex: ${questionIndex}`);

            const session = systemDesignSessions[reviewIndex];
            if (!session) {
                console.error(`No session found for reviewIndex: ${reviewIndex}`);
                return;
            }

            const questionKey = `${reviewIndex}-${questionIndex}`;
            const answerTextarea = document.getElementById(`answer-${reviewIndex}-${questionIndex}`);

            if (!answerTextarea) {
                console.error(`No textarea found with ID: answer-${reviewIndex}-${questionIndex}`);
                return;
            }

            const answer = answerTextarea.value.trim();

            if (!answer) {
                alert('Please enter an answer before marking as complete.');
                return;
            }

            // Record the answer
            const questionId = session.questions[questionIndex]?.id || questionKey;
            session.answers[questionId] = answer;

            // Calculate time for this question (should already be started)
            const startTime = session.questionStartTimes[questionKey];
            if (!startTime) {
                console.warn(`No start time found for question ${questionKey}, using current time`);
                session.questionStartTimes[questionKey] = Date.now();
            }

            const elapsed = Date.now() - session.questionStartTimes[questionKey] - session.pausedTime;
            const minutes = Math.round(elapsed / 60000);

            // Update display to final time
            const timeDisplay = document.getElementById(`answer-time-${reviewIndex}-${questionIndex}`);
            if (timeDisplay) {
                timeDisplay.textContent = `${minutes} min`;
            } else {
                console.error(`No time display found with ID: answer-time-${reviewIndex}-${questionIndex}`);
            }

            // Disable the button
            const answerButton = document.querySelector(`#answer-section-${reviewIndex}-${questionIndex} .mark-answered-btn`);
            if (answerButton) {
                answerButton.disabled = true;
                answerButton.textContent = '‚úÖ Answered';
                answerButton.style.background = '#6c757d';
                console.log(`Question ${questionIndex + 1} answered in ${minutes} minutes`);
            } else {
                console.error(`No answer button found with selector: #answer-section-${reviewIndex}-${questionIndex} .mark-answered-btn`);
            }
        }

        async function stopSystemDesignPractice(reviewIndex) {
            console.log(`stopSystemDesignPractice called for review ${reviewIndex}`);

            const session = systemDesignSessions[reviewIndex];
            if (!session) {
                console.error(`No active system design session found for review ${reviewIndex}`);
                alert('No active practice session found. The session may have already been stopped.');
                return;
            }

            try {
                // Stop the timer
                clearInterval(session.interval);
                console.log('Timer interval cleared');

                // Prepare session data for rating calculation
                const sessionData = {
                    total_time: Math.round(session.totalMinutes),
                    answers: session.answers,
                    questions: session.questions,
                    self_assessment: {} // Will be filled by user if needed
                };
                console.log(`Total practice time: ${sessionData.total_time} minutes`);

                try {
                    // Calculate suggested rating
                    const response = await fetch('/api/calculate-system-design-rating', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_data: sessionData,
                            benchmarks: session.benchmarks
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const suggestedRating = result.suggested_rating;

                        // Show practice summary
                        const summaryElement = document.getElementById(`practice-summary-${reviewIndex}`);
                        if (summaryElement) summaryElement.style.display = 'block';

                        const timeElement = document.getElementById(`total-practice-time-${reviewIndex}`);
                        if (timeElement) timeElement.textContent = sessionData.total_time;

                        const ratingElement = document.getElementById(`suggested-rating-${reviewIndex}`);
                        if (ratingElement) {
                            ratingElement.textContent = `${suggestedRating} (${getRatingDescription(suggestedRating)})`;
                        }

                        // Update the rating dropdown and show suggestion
                        const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
                        if (ratingSelect) ratingSelect.value = suggestedRating;

                        const suggestionSpan = document.getElementById(`rating-suggestion-${reviewIndex}`);
                        if (suggestionSpan) {
                            suggestionSpan.textContent = `(Suggested: ${suggestedRating})`;
                            suggestionSpan.style.display = 'inline';
                        }

                        // Store session data for completion
                        session.sessionData = sessionData;

                        console.log(`System design practice completed: ${sessionData.total_time} minutes, suggested rating: ${suggestedRating}`);
                    } else {
                        console.error('Failed to calculate rating:', response.status, response.statusText);
                    }

                } catch (error) {
                    console.error('Error calculating rating:', error);
                }

                // Hide practice controls
                const timerElement = document.getElementById(`practice-timer-${reviewIndex}`);
                const pauseElement = document.getElementById(`pause-practice-${reviewIndex}`);
                const stopElement = document.getElementById(`stop-practice-${reviewIndex}`);

                if (timerElement) timerElement.style.display = 'none';
                if (pauseElement) {
                    pauseElement.style.display = 'none';
                    pauseElement.innerHTML = '‚è∏Ô∏è Pause';
                    pauseElement.style.background = '#ffc107';
                }
                if (stopElement) stopElement.style.display = 'none';

                // Clean up localStorage for this session when practice is stopped
                if (session && session.sessionKey) {
                    localStorage.removeItem(`practice_session_${session.sessionKey}`);
                    console.log('Cleared localStorage for stopped session:', session.sessionKey);
                }

                // Re-enable start button
                const startButton = document.querySelector(`button[onclick*="startSystemDesignPractice(${reviewIndex}"]`);
                if (startButton) {
                    startButton.disabled = false;
                    startButton.textContent = 'üèÉ Start System Design Practice';
                }

                console.log('System design practice stopped successfully');

            } catch (error) {
                console.error('Error stopping system design practice:', error);
                alert('Error stopping practice session. Please refresh the page.');
            }
        }

        // Enhanced markComplete function to include practice data
        async function markCompleteWithPracticeData(topic, track, type, reviewIndex = null) {
            // Get base completion data
            let rating, notes;
            let practiceData = null;

            if (type === 'review' && reviewIndex !== null) {
                const ratingSelect = document.getElementById(`review-rating-${reviewIndex}`);
                const notesTextarea = document.getElementById(`review-notes-${reviewIndex}`);
                rating = parseInt(ratingSelect.value);
                notes = notesTextarea.value;

                // Include practice data if available
                const timer = reviewPracticeTimers[reviewIndex];
                if (timer && completedProblems[reviewIndex]) {
                    practiceData = {
                        practice_time: Math.round(timer.totalMinutes),
                        problem_times: completedProblems[reviewIndex],
                        suggested_rating: parseInt(document.getElementById(`suggested-rating-${reviewIndex}`).textContent.charAt(0))
                    };
                }
            }

            // Prepare request data
            const requestData = {
                topic: topic,
                track: track,
                type: type,
                rating: rating,
                notes: notes
            };

            // Add practice data if available
            if (practiceData) {
                Object.assign(requestData, practiceData);
            }

            // Disable the review section to prevent double-submission
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (reviewElement) {
                reviewElement.style.pointerEvents = 'none';
                const button = reviewElement.querySelector('.complete-btn');
                if (button) {
                    button.textContent = '‚è≥ Saving...';
                    button.style.background = '#6c757d';
                }
            }

            // Make the completion request
            try {
                const response = await fetch('/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    console.log('Review completed successfully with practice data');

                    // Clean up localStorage for system design sessions
                    const systemDesignSession = systemDesignSessions[reviewIndex];
                    if (systemDesignSession && systemDesignSession.sessionKey) {
                        localStorage.removeItem(`practice_session_${systemDesignSession.sessionKey}`);
                        console.log('Cleared localStorage for completed session:', systemDesignSession.sessionKey);
                    }

                    // Show completion summary instead of immediate reload
                    showReviewCompletionSummary(reviewIndex, topic, track, rating, notes, practiceData);

                    // Clean up practice data
                    if (reviewIndex !== null) {
                        delete reviewPracticeTimers[reviewIndex];
                        delete completedProblems[reviewIndex];
                        delete systemDesignSessions[reviewIndex];
                    }
                } else {
                    console.error('Failed to complete review');
                    // Re-enable on error
                    if (reviewElement) {
                        reviewElement.style.pointerEvents = 'auto';
                        const button = reviewElement.querySelector('.complete-btn');
                        if (button) {
                            button.textContent = '‚úÖ Review Complete';
                            button.style.background = '#28a745';
                        }
                    }
                    alert('‚ùå Error saving completion. Please try again.');
                }
            } catch (error) {
                console.error('Error completing review:', error);
                // Re-enable on error
                if (reviewElement) {
                    reviewElement.style.pointerEvents = 'auto';
                    const button = reviewElement.querySelector('.complete-btn');
                    if (button) {
                        button.textContent = '‚úÖ Review Complete';
                        button.style.background = '#28a745';
                    }
                }
                alert('‚ùå Network error. Please check your connection and try again.');
            }
        }

        function showReviewCompletionSummary(reviewIndex, topic, track, rating, notes, practiceData) {
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (!reviewElement) return;

            // Create completion summary
            let summaryHTML = `
                <div class="completed-message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>‚úÖ ${track.charAt(0).toUpperCase() + track.slice(1)}: ${topic} Review Complete!</h4>
                    <p><strong>Rating:</strong> ${rating}/5 (${getRatingDescription(rating)})</p>
                    ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ''}
            `;

            // Add practice summary if available
            if (practiceData) {
                summaryHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                        <h5>üéØ Practice Session Results:</h5>
                        <p><strong>Total Practice Time:</strong> ${practiceData.practice_time} minutes</p>
                        <p><strong>Problems Completed:</strong> ${practiceData.problem_times.length}</p>
                `;

                if (practiceData.problem_times.length > 0) {
                    summaryHTML += '<p><strong>Individual Problem Times:</strong></p><ul>';
                    practiceData.problem_times.forEach((problem, idx) => {
                        summaryHTML += `<li>Problem ${idx + 1}: ${problem.timeMinutes} min</li>`;
                    });
                    summaryHTML += '</ul>';
                }
                summaryHTML += '</div>';
            }

            summaryHTML += `
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            üîÑ Refresh Dashboard
                        </button>
                        <button onclick="hideCompletionSummary(${reviewIndex})" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ‚ùå Dismiss
                        </button>
                    </div>
                    <p style="margin-top: 10px;"><em>Great job! Keep up the momentum! üöÄ</em></p>
                </div>
            `;

            // Hide the form elements and show summary
            const formElements = reviewElement.querySelectorAll('.rating, .notes, .complete-btn, .review-practice-section');
            formElements.forEach(el => el.style.display = 'none');

            reviewElement.insertAdjacentHTML('beforeend', summaryHTML);
        }

        function hideCompletionSummary(reviewIndex) {
            const reviewElement = document.getElementById(`review-${reviewIndex}`);
            if (reviewElement) {
                // Just hide the entire review element
                reviewElement.style.display = 'none';
            }
        }

        // Acceleration feature functions
        async function checkAdvancement(track) {
            try {
                const response = await fetch('/api/get-advancement-info?track=' + track);
                const data = await response.json();

                if (data.success) {
                    const checkDiv = document.getElementById(`${track}-advance-check`);
                    const optionDiv = document.getElementById(`${track}-advance-option`);

                    if (data.can_advance) {
                        // Show advancement option
                        checkDiv.style.display = 'none';
                        optionDiv.style.display = 'block';
                        optionDiv.innerHTML = `
                            <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; border: 1px solid #28a745;">
                                <p style="margin: 0 0 10px 0; color: #155724; font-weight: bold;">
                                    üéâ Great progress! You've completed Day ${data.current_day}.
                                </p>
                                <p style="margin: 0 0 15px 0; color: #155724;">
                                    Ready to advance to Day ${data.next_day}? This will unlock tomorrow's content today!
                                </p>
                                <button onclick="advanceDay('${track}')"
                                        style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                    ‚ö° Advance to Day ${data.next_day}
                                </button>
                                <button onclick="cancelAdvancement('${track}')"
                                        style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        `;
                    } else {
                        // Show message explaining why advancement is not available
                        checkDiv.style.display = 'none';
                        optionDiv.style.display = 'block';
                        optionDiv.innerHTML = `
                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffc107;">
                                <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">
                                    üìÖ Day ${data.current_day} Status
                                </p>
                                <p style="margin: 0 0 15px 0; color: #856404;">
                                    ${data.reason}
                                </p>
                                <button onclick="cancelAdvancement('${track}')"
                                        style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        `;
                    }
                } else {
                    alert('Error checking advancement status: ' + data.message);
                }
            } catch (error) {
                console.error('Error checking advancement:', error);
                alert('Error checking advancement status. Please try again.');
            }
        }

        async function advanceDay(track) {
            try {
                const response = await fetch('/api/advance-day', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ track: track })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`üöÄ Advanced to Day ${data.new_day}! The page will now refresh to show your new content.`);
                    window.location.reload();
                } else {
                    alert('Error advancing day: ' + data.message);
                }
            } catch (error) {
                console.error('Error advancing day:', error);
                alert('Error advancing day. Please try again.');
            }
        }

        function cancelAdvancement(track) {
            const checkDiv = document.getElementById(`${track}-advance-check`);
            const optionDiv = document.getElementById(`${track}-advance-option`);

            checkDiv.style.display = 'block';
            optionDiv.style.display = 'none';
        }

        // Toggle answer visibility
        function toggleAnswer(button) {
            const answerDiv = button.nextElementSibling;
            if (answerDiv.style.display === 'none') {
                answerDiv.style.display = 'block';
                button.textContent = 'üîí Hide Answer';
            } else {
                answerDiv.style.display = 'none';
                button.textContent = 'üí° Show Answer';
            }
        }

    </script>
</body>
</html>