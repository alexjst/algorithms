.PHONY: setup install run clean test help

# Variables
VENV_DIR = venv
PYTHON = $(VENV_DIR)/bin/python
PIP = $(VENV_DIR)/bin/pip

# Default target
help:
	@echo "üìö Study Tracker - Available Commands:"
	@echo ""
	@echo "  make setup    - Create virtual environment and install dependencies"
	@echo "  make run      - Start the study tracker application"
	@echo "  make install  - Install/update dependencies"
	@echo "  make clean    - Remove virtual environment"
	@echo "  make test     - Run basic tests"
	@echo "  make help     - Show this help message"
	@echo ""
	@echo "üöÄ Quick start: make setup && make run"

# Create virtual environment and install dependencies
setup: $(VENV_DIR)
	@echo "‚úÖ Setup complete! Run 'make run' to start the application."

$(VENV_DIR):
	@echo "üîß Creating virtual environment..."
	python3 -m venv $(VENV_DIR)
	@echo "üì¶ Installing dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "‚úÖ Virtual environment created and dependencies installed"

# Install/update dependencies
install: $(VENV_DIR)
	@echo "üì¶ Installing/updating dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt

# Run the application
run: $(VENV_DIR)
	@echo "üöÄ Starting Study Tracker..."
	@echo "üìñ Open http://localhost:5000 in your browser"
	@echo "‚èπÔ∏è  Press Ctrl+C to stop"
	@echo ""
	$(PYTHON) app.py

# Run basic tests
test: $(VENV_DIR)
	@echo "üß™ Running basic tests..."
	$(PYTHON) -c "import yaml, json; print('‚úÖ YAML and JSON modules work')"
	$(PYTHON) -c "import flask; print('‚úÖ Flask module works')"
	$(PYTHON) -c "from app import app; print('‚úÖ App imports successfully')"
	@echo "‚úÖ All basic tests passed"

# Clean up virtual environment
clean:
	@echo "üßπ Cleaning up virtual environment..."
	rm -rf $(VENV_DIR)
	@echo "‚úÖ Virtual environment removed"

# Development mode with auto-reload
dev: $(VENV_DIR)
	@echo "üîß Starting in development mode..."
	@echo "üìñ Open http://localhost:5000 in your browser"
	@echo "üîÑ Auto-reload enabled"
	FLASK_ENV=development $(PYTHON) app.py

# Check if data files exist and create them if needed
init-data:
	@echo "üìÅ Checking data files..."
	@test -f data/progress.json || echo '{"completions": []}' > data/progress.json
	@test -f data/reviews.json || echo '{"scheduled_reviews": []}' > data/reviews.json
	@echo "‚úÖ Data files ready"

# Show status of the project
status:
	@echo "üìä Study Tracker Status:"
	@echo ""
	@if [ -d "$(VENV_DIR)" ]; then \
		echo "‚úÖ Virtual environment: EXISTS"; \
	else \
		echo "‚ùå Virtual environment: MISSING (run 'make setup')"; \
	fi
	@if [ -f "data/progress.json" ]; then \
		echo "‚úÖ Progress data: EXISTS"; \
	else \
		echo "‚ö†Ô∏è  Progress data: MISSING"; \
	fi
	@if [ -f "data/reviews.json" ]; then \
		echo "‚úÖ Reviews data: EXISTS"; \
	else \
		echo "‚ö†Ô∏è  Reviews data: MISSING"; \
	fi